(function(e,t){e(["JC.BaseMVC"],function(){function e(t){t&&(t=$(t));if(e.getInstance(t))return e.getInstance(t);e.getInstance(t,this),this._model=new e.Model(t),this._view=new e.View(this._model),this._init(),JC.log("AutoComplete inited",(new Date).getTime())}return JC.AutoComplete=e,e.getInstance=function(t,n){typeof t=="string"&&!/</.test(t)&&(t=$(t));if(!t||!t.length||typeof t=="string")return;return typeof n!="undefined"&&t.data(e.Model._instanceName,n),t.data(e.Model._instanceName)},e.init=function(t){var n=[];return t=$(t||document),t&&t.length&&(t.hasClass("js_compAutoComplete")?n.push(new e(t)):t.find("input.js_compAutoComplete").each(function(){n.push(new e(this))})),n},e.update=function(t,n){var r=e.getInstance(t);return!r&&(r=new e(t)),r&&r.update(n),r},e.ajaxUpdate=function(t,n,r){var i=e.getInstance(t);return!i&&(i=new e(t)),i&&i.ajaxUpdate(n,r),i},e.dataFilter,e.fixHtmlEntity=!0,BaseMVC.build(e),JC.f.extendObject(e.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var t=this;t._model.selector().on("click",function(e){e.stopPropagation()}),t._model.selector().on("focus",function(){t._view.updateList(),t.trigger(e.Model.SHOW),t.selector().addClass(e.Model.CLASS_FAKE)}),t._model.selector().on("blur",function(){t._model.preVal=t._model.selector().val().trim(),t.selector().removeClass(e.Model.CLASS_FAKE),t._model.verifyKey()}),t._model.selector().on("keyup",function(n){var r=n.keyCode,i=$(this),s=i.val().trim();if(r==38||r==40)e.Model.isScroll=!0;JC.log("keyup",r,(new Date).getTime());if(r)switch(r){case 38:case 40:n.preventDefault();case 37:case 39:return;case 27:t.trigger(e.Model.HIDDEN);return}}),t._model.selector().on("keydown",function(n){var r=n.keyCode,i=t._model.selector().val().trim();if(r==38||r==40)e.Model.isScroll=!0;JC.log("keydown",(new Date).getTime());if(r){switch(r){case 40:case 38:case 13:if(!t._model.popup().is(":visible"))return}t._model.popup().is(":visible")||t.trigger(e.Model.SHOW);switch(r){case 40:case 38:t.trigger(e.Model.UPDATE_LIST_INDEX,[r,n]);return;case 37:case 39:return;case 13:t.trigger(e.Model.ENTER,[n]);return;case 9:case 27:t.trigger(e.Model.HIDDEN);return}}t._model.keydownTimeout(setTimeout(function(){t.trigger(e.Model.UPDATE_LIST)},200))}),t._model.popup().on("click",function(e){e.stopPropagation()}),t._model.popup().delegate("li","click",function(n){if(!$(this).is("["+t._model.cacLabelKey()+"]"))return;t.trigger(e.Model.CHANGE,[$(this)]),t.trigger(e.Model.HIDDEN),t._model.blurTimeout(setTimeout(function(){t._model.selector().trigger("blur")},50))}),t.on(e.Model.HIDDEN,function(){t._view.hide()}),t.on(e.Model.SHOW,function(){t._view.show()}),t._model.popup().delegate("> li","mouseenter",function(r){if(e.Model.isScroll)return;t._view.updateIndex($(this).attr("data-index"),!0)}),t.on(e.Model.ENTER,function(n,r){t._model.cacPreventEnter()&&r.preventDefault();var i=t._model.selectedItem();i&&i.length&&t.trigger(e.Model.CHANGE,[i]),t.trigger(e.Model.HIDDEN)}),t.on(e.Model.UPDATE_LIST_INDEX,function(n,r,i){i.preventDefault(),JC.log(e.Model.UPDATE_LIST_INDEX,r,(new Date).getTime()),t._view.updateListIndex(r==40?!0:!1);var s=t._model.selectedItem();s&&s.length&&t.trigger(e.Model.CHANGE,[s])}),t.on(e.Model.UPDATE_LIST,function(e){this._view.updateList(this._model.selector())}),t.on(e.Model.CHANGE,function(e,n){t._model.setSelectorData(n)}),t.on(e.Model.UPDATE,function(e,n,r){t._model.initPopupData(n),t._view.build(n),r&&r.call(t,n)}),t.on(e.Model.CLEAR,function(e){t._model.selector().val(""),t._model.setIdSelectorData()}),t._model.selector().on(e.Model.REMOVE,function(){try{t._model.popup().remove()}catch(e){}})},_inited:function(){var e=this;e._model.initData=e._model.dataItems(),e.ajaxUpdate(),e._model.selector().is("[validCheckTimeout]")||e._model.selector().attr("validCheckTimeout",e._model.cacValidCheckTimeout())},idSelector:function(){return this._model.cacIdSelector()},idVal:function(){return this._model.cacIdVal()},ajaxUpdate:function(e,t){return this._model.ajaxData(e,t),this},show:function(){var t=this;return setTimeout(function(){t.trigger(e.Model.SHOW)},1),t},hide:function(){return this.trigger(e.Model.HIDDEN),this},popup:function(){return this._model.popup()},update:function(t){var n=this;return!n._model.firstUpdate&&n.clear(),n._model.firstUpdate=!1,t=n._model.cacDataFilter(t),n.trigger(e.Model.UPDATE,[t]),n.trigger(e.Model.UPDATE_LIST),n},clear:function(){return this.trigger(e.Model.CLEAR),this},fixPosition:function(){var e=this._model.popup();return e&&e.length&&e.is(":visible")&&this._view.show(),this}}),e.Model._instanceName="AutoComplete",e.Model.UPDATE="AC_UPDATE",e.Model.CLEAR="AC_CLEAR",e.Model.ENTER="AC_ENTER",e.Model.CHANGE="AC_CHANGE",e.Model.HIDDEN="AC_HIDDEN",e.Model.SHOW="AC_SHOW",e.Model.UPDATE_LIST="AC_UPDATE_LIST",e.Model.UPDATE_LIST_INDEX="AC_UPDATE_LIST_INDEX",e.Model.REMOVE="AC_AUTOCOMPLETE_REMOVE",e.Model.CLASS_ACTIVE="AC_active",e.Model.CLASS_FAKE="AC_fakebox",e.Model.AJAX_CACHE={},JC.f.extendObject(e.Model.prototype,{init:function(){this.initData,this._cache={},this.firstUpdate=!0},listItemTpl:function(){var e=JC.f.printf("<li "+this.cacIdKey()+'="{0}" '+this.cacLabelKey()+'="{1}"'+' data-index="{2}" class="AC_listItem {3}">{1}</li>');return e},popup:function(){var e=this,t=e.selector().data("AC_panel");!t&&(t=this.selectorProp("cacPopup"));if(!t||!t.length)t=$(JC.f.printf('<ul class="AC_box js_compAutoCompleteBox"{0}>{1}</ul>',' style="display:none;position:absolute;"','<li style="text-align:center;">'+e.cacNoDataText()+"</li>")),e.selector().data("AC_panel",t),t.appendTo(document.body);return this._inited||(this._inited=!0,t.css({width:e.cacBoxWidth()+"px"})),t},initPopupData:function(e){this.initData=e},verifyKey:function(){if(!this.cacStrictData())return;var e=this,t=this.selector().val().trim(),n=[],r=e.selector().is("[cacIdKey]"),i;if(!t){e.selector().val(""),e.setIdSelectorData();return}if(t){var s=e.cacIdVal(),o,u;$.each(e.initData,function(a,f){if(r){var l=f.label.trim();l===t&&(i=!0,!u&&e.setIdSelectorData(f.id),u=!0),l===t&&!s&&e.setIdSelectorData(s=f.id);if(l===t&&f.id===s)return n.push(f),!o&&e.setIdSelectorData(f.id),o=!0,i=!0,!1}else f.label.trim()==t&&(n.push(f),i=!0)})}i||(e.selector().val(""),e.setIdSelectorData())},cache:function(e){return JC.log("................cache",e),e in this._cache||(this._cache[e]=this.keyData(e)||this.initData),this._cache[e]},dataItems:function(){var e=this,t=e.listItems(),n=[];return t.each(function(t,r){var i=$(this);n.push({id:i.attr(e.cacIdKey())||"",label:i.attr(e.cacLabelKey())})}),n},ajaxData:function(t,n){var r=this,t=t||r.attrProp("cacAjaxDataUrl");if(!t)return;if(t in e.Model.AJAX_CACHE){$(r).trigger("TriggerEvent",[e.Model.UPDATE,e.Model.AJAX_CACHE[t],n]);return}$.get(t).done(function(i){i=$.parseJSON(i),i=r.cacDataFilter(i),e.Model.AJAX_CACHE[t]=i,$(r).trigger("TriggerEvent",[e.Model.UPDATE,e.Model.AJAX_CACHE[t],n])})},keyData:function(e){var t=this,n=t.initData,r=0,i=t.cacCasesensitive(),s=e.toLowerCase(),o=[[],[],[],[]],u=[];for(r=0;r<n.length;r++){var a=n[r].label.toLowerCase();n[r].label.indexOf(e)==0?o[n[r].tag=0].push(n[r]):!i&&a.indexOf(s)==0?o[n[r].tag=1].push(n[r]):n[r].label.indexOf(e)>0?o[n[r].tag=2].push(n[r]):!i&&a.indexOf(s)>0&&o[n[r].tag=3].push(n[r])}return $.each(o,function(e,t){u=u.concat(t)}),u},setSelectorData:function(e){e&&(e=$(e));if(!e||!e.length)return;var t=this,n=e.attr(t.cacLabelKey()).trim(),r=e.attr(t.cacIdKey()).trim();t.selector().val(n),t.selector().attr("cacIdVal",r),t.setIdSelectorData(r)},setIdSelectorData:function(e){var t=this;if(!t.cacIdSelector()||!t.cacIdSelector().length)return;typeof e!="undefined"?(t.cacIdSelector().val(e),t.selector().attr("cacIdVal",e)):(t.cacIdSelector().val(""),t.selector().attr("cacIdVal",""))},listItems:function(){var e;return this.popup()&&this.popup().length&&(e=this.popup().find(this.cacSubItemsSelector())),e},selectedItem:function(){var t;return this.listItems().each(function(){var n=$(this);if(n.hasClass(e.Model.CLASS_ACTIVE))return t=n,!1}),t},keyupTimeout:function(e){this._keyupTimeout&&clearTimeout(this._keyupTimeout),this._keyupTimeout=e},keydownTimeout:function(e){this._keydownTimeout&&clearTimeout(this._keydownTimeout),this._keydownTimeout=e},blurTimeout:function(e){this._blurTimeout&&clearTimeout(this._blurTimeout),this._blurTimeout=e},cacDataFilter:function(t){var n=this,r=n.callbackProp("cacDataFilter")||e.dataFilter;return r&&(t=r(t)),n.cacFixHtmlEntity()&&$.each(t,function(e,t){t.label&&(t.label=$("<p>"+t.label+"</p>").text())}),t},cacNoDataText:function(){var e=this.attrProp("cacNoDataText")||"数据加载中, 请稍候...";return e},cacValidCheckTimeout:function(){var t=this.intProp("cacValidCheckTimeout")||e.validCheckTimeout||1;return t},cacStrictData:function(){var e=this.boolProp("cacStrictData");return e},cacFixHtmlEntity:function(){var t=e.fixHtmlEntity;return this.selector().is("[cacFixHtmlEntity]")&&(t=this.boolProp("cacFixHtmlEntity")),t},cacLabelKey:function(){var e=this.attrProp("cacLabelKey")||"data-label";return e},cacIdKey:function(e){typeof e!="undefined"&&this.selector().attr("cacIdKey",e);var t=this.attrProp("cacIdKey")||this.cacLabelKey();return t},cacIdVal:function(){var e=this,t=e.attrProp("cacIdVal");return e.cacIdSelector()&&e.cacIdSelector().length&&(t=e.cacIdSelector().val()),t=(t||"").trim(),t},cacIdSelector:function(){var e=this.selectorProp("cacIdSelector");return e},cacPreventEnter:function(){var e;return e=this.selector().is("[cacPreventEnter]")&&JC.f.parseBool(this.selector().attr("cacPreventEnter")),e},cacBoxWidth:function(){var e=this.intProp("cacBoxWidth");return!e&&(e=this.selector().width()),e},cacCasesensitive:function(){return this.boolProp("cacCasesensitive")},cacSubItemsSelector:function(){var e=this.attrProp("cacSubItemsSelector")||"> li";return e+="["+this.cacLabelKey()+"]",e}}),JC.f.extendObject(e.View.prototype,{init:function(){var t=this;t._model.listItems().each(function(e){$(this).attr("data-index",e)}).removeClass(e.Model.CLASS_ACTIVE).first().addClass(e.Model.CLASS_ACTIVE)},hide:function(){var e=this;e._model.popup().hide()},show:function(){var t=this,n=t._model.selector().offset(),r=t._model.selector().prop("offsetHeight"),i=t._model.selector().prop("offsetWidth");t._model.popup().css({top:n.top+r+"px",left:n.left+"px"});var s,o=t._model.selector().val().trim(),u=t._model.cacIdVal(),a=t._model.cacLabelKey()!=t._model.cacIdKey();t._model.listItems().each(function(){var n=$(this),r=n.attr(t._model.cacLabelKey()),i=n.attr(t._model.cacIdKey());n.removeClass(e.Model.CLASS_ACTIVE),o==r&&(a&&u?(u==i&&n.addClass(e.Model.CLASS_ACTIVE),s=n):(n.addClass(e.Model.CLASS_ACTIVE),s=n))}),s||t._model.listItems().first().addClass(e.Model.CLASS_ACTIVE),t._model.popup().show()},updateList:function(){var e=this,t,n=[],r=e._model.selector().val().trim(),i=e._model.cacIdVal(),s;r?s=e._model.cache(r,i):s=e._model.initData,s&&e.build(s)},build:function(t){var n=this,r=0,i=[];if(t.length==0)n.hide();else{for(;r<t.length;r++)i.push(JC.f.printf(n._model.listItemTpl(),t[r].id,t[r].label,r,r===0?e.Model.CLASS_ACTIVE:""));n._model.popup().html(i.join(""))}},currentIndex:function(t){var n=this,r=n._model.popup(),i=n._model.listItems(),s=-1;if(!i.length)return;return i.each(function(t){var n=$(this);if(n.hasClass(e.Model.CLASS_ACTIVE))return s=t,!1}),s<0?s=t?0:i.length-1:(s=t?s+1:s-1,s<0?s=i.length-1:s>=i.length&&(s=0)),s},updateListIndex:function(e){var t=this,n=t.currentIndex(e);t.updateIndex(n)},updateIndex:function(t,n){var r=this,i=r._model.listItems();r.removeActiveClass(),$(i[t]).addClass(e.Model.CLASS_ACTIVE),!n&&r.setScroll(t)},setScroll:function(t){var n=this,r=n._model.listItems().eq(t),i=r.position().top+r.height(),s=n._model.popup().innerHeight(),o=n._model.popup().scrollTop();i+=o,t==-1?(n._model.selector().focus(),n._model.listItems().removeClass(e.Model.CLASS_ACTIVE)):(n._model.listItems().removeClass(e.Model.CLASS_ACTIVE),r.addClass(e.Model.CLASS_ACTIVE),i>s&&n._model.popup().scrollTop(i-s),r.position().top<0&&n._model.popup().scrollTop(0)),e.Model.SCROLL_TIMEOUT&&clearTimeout(e.Model.SCROLL_TIMEOUT),e.Model.SCROLL_TIMEOUT=setTimeout(function(){e.Model.isScroll=!1},500)},removeActiveClass:function(){this._model.listItems().removeClass(e.Model.CLASS_ACTIVE)}}),$.event.special[e.Model.REMOVE]={remove:function(e){e.handler&&e.handler()}},$(window).on("resize",function(t){$("input.js_compAutoComplete").each(function(){var t=e.getInstance($(this));t&&t.fixPosition()})}),$(document).on("click",function(){$("ul.js_compAutoCompleteBox, div.js_compAutoCompleteBox").hide()}),$(document).delegate("input.js_compAutoComplete","focus",function(t){!e.getInstance(this)&&new e(this)}),JC.AutoComplete})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);