(function(e,t){e(["JC.BaseMVC"],function(){return function(e){function t(n){n&&(n=e(n));if(t.getInstance(n))return t.getInstance(n);t.getInstance(n,this),this._model=new t.Model(n),this._view=new t.View(this._model),this._init(),JC.log("AutoComplete inited",(new Date).getTime())}JC.AutoComplete=t,t.getInstance=function(n,r){typeof n=="string"&&!/</.test(n)&&(n=e(n));if(!n||!n.length||typeof n=="string")return;return typeof r!="undefined"&&n.data(t.Model._instanceName,r),n.data(t.Model._instanceName)},t.init=function(n){var r=[];return n=e(n||document),n&&n.length&&(n.hasClass("js_compAutoComplete")?r.push(new t(n)):n.find("input.js_compAutoComplete").each(function(){r.push(new t(this))})),r},t.update=function(e,n){var r=t.getInstance(e);return!r&&(r=new t(e)),r&&r.update(n),r},t.ajaxUpdate=function(e,n,r){var i=t.getInstance(e);return!i&&(i=new t(e)),i&&i.ajaxUpdate(n,r),i},t.dataFilter,BaseMVC.build(t),JC.f.extendObject(t.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var n=this;n._model.selector().on("click",function(e){e.stopPropagation()}),n._model.selector().on("focus",function(){n._view.updateList(),n.trigger(t.Model.SHOW),n.selector().addClass(t.Model.CLASS_FAKE)}),n._model.selector().on("blur",function(){n._model.preVal=n._model.selector().val().trim(),n.selector().removeClass(t.Model.CLASS_FAKE),n._model.verifyKey()}),n._model.selector().on("keyup",function(r){var i=r.keyCode,s=e(this),o=s.val().trim();if(i==38||i==40)t.Model.isScroll=!0;JC.log("keyup",i,(new Date).getTime());if(i)switch(i){case 38:case 40:r.preventDefault();case 37:case 39:return;case 27:n.trigger(t.Model.HIDDEN);return}}),n._model.selector().on("keydown",function(e){var r=e.keyCode,i=n._model.selector().val().trim();if(r==38||r==40)t.Model.isScroll=!0;JC.log("keydown",(new Date).getTime());if(r){switch(r){case 40:case 38:case 13:if(!n._model.popup().is(":visible"))return}n._model.popup().is(":visible")||n.trigger(t.Model.SHOW);switch(r){case 40:case 38:n.trigger(t.Model.UPDATE_LIST_INDEX,[r,e]);return;case 37:case 39:return;case 13:n.trigger(t.Model.ENTER,[e]);return;case 9:case 27:n.trigger(t.Model.HIDDEN);return}}n._model.keydownTimeout(setTimeout(function(){n.trigger(t.Model.UPDATE_LIST)},200))}),n._model.popup().on("click",function(e){e.stopPropagation()}),n._model.popup().delegate("li","click",function(r){if(!e(this).is("["+n._model.cacLabelKey()+"]"))return;n.trigger(t.Model.CHANGE,[e(this)]),n.trigger(t.Model.HIDDEN),n._model.blurTimeout(setTimeout(function(){n._model.selector().trigger("blur")},50))}),n.on(t.Model.HIDDEN,function(){n._view.hide()}),n.on(t.Model.SHOW,function(){n._view.show()}),n._model.popup().delegate("> li","mouseenter",function(i){if(t.Model.isScroll)return;n._view.updateIndex(e(this).attr("data-index"),!0)}),n.on(t.Model.ENTER,function(e,r){n._model.cacPreventEnter()&&r.preventDefault();var i=n._model.selectedItem();i&&i.length&&n.trigger(t.Model.CHANGE,[i]),n.trigger(t.Model.HIDDEN)}),n.on(t.Model.UPDATE_LIST_INDEX,function(e,r,i){i.preventDefault(),JC.log(t.Model.UPDATE_LIST_INDEX,r,(new Date).getTime()),n._view.updateListIndex(r==40?!0:!1);var s=n._model.selectedItem();s&&s.length&&n.trigger(t.Model.CHANGE,[s])}),n.on(t.Model.UPDATE_LIST,function(e){this._view.updateList(this._model.selector())}),n.on(t.Model.CHANGE,function(e,t){n._model.setSelectorData(t)}),n.on(t.Model.UPDATE,function(e,t,r){n._model.initPopupData(t),n._view.build(t),r&&r.call(n,t)}),n.on(t.Model.CLEAR,function(e){n._model.selector().val(""),n._model.setIdSelectorData()}),n._model.selector().on(t.Model.REMOVE,function(){try{n._model.popup().remove()}catch(e){}})},_inited:function(){var e=this;e._model.initData=e._model.dataItems(),e.ajaxUpdate(),e._model.selector().is("[validCheckTimeout]")||e._model.selector().attr("validCheckTimeout",e._model.cacValidCheckTimeout())},idSelector:function(){return this._model.cacIdSelector()},idVal:function(){return this._model.cacIdVal()},ajaxUpdate:function(e,t){return this._model.ajaxData(e,t),this},show:function(){var e=this;return setTimeout(function(){e.trigger(t.Model.SHOW)},1),e},hide:function(){return this.trigger(t.Model.HIDDEN),this},popup:function(){return this._model.popup()},update:function(e){var n=this;return!n._model.firstUpdate&&n.clear(),n._model.firstUpdate=!1,e=n._model.cacDataFilter(e),n.trigger(t.Model.UPDATE,[e]),n.trigger(t.Model.UPDATE_LIST),n},clear:function(){return this.trigger(t.Model.CLEAR),this},fixPosition:function(){var e=this._model.popup();return e&&e.length&&e.is(":visible")&&this._view.show(),this}}),t.Model._instanceName="AutoComplete",t.Model.UPDATE="AC_UPDATE",t.Model.CLEAR="AC_CLEAR",t.Model.ENTER="AC_ENTER",t.Model.CHANGE="AC_CHANGE",t.Model.HIDDEN="AC_HIDDEN",t.Model.SHOW="AC_SHOW",t.Model.UPDATE_LIST="AC_UPDATE_LIST",t.Model.UPDATE_LIST_INDEX="AC_UPDATE_LIST_INDEX",t.Model.REMOVE="AC_AUTOCOMPLETE_REMOVE",t.Model.CLASS_ACTIVE="AC_active",t.Model.CLASS_FAKE="AC_fakebox",t.Model.AJAX_CACHE={},JC.f.extendObject(t.Model.prototype,{init:function(){this.initData,this._cache={},this.firstUpdate=!0},listItemTpl:function(){var e=JC.f.printf("<li "+this.cacIdKey()+'="{0}" '+this.cacLabelKey()+'="{1}"'+' data-index="{2}" class="AC_listItem {3}">{1}</li>');return e},popup:function(){var t=this,n=t.selector().data("AC_panel");!n&&(n=this.selectorProp("cacPopup"));if(!n||!n.length)n=e(JC.f.printf('<ul class="AC_box js_compAutoCompleteBox"{0}>{1}</ul>',' style="display:none;position:absolute;"','<li style="text-align:center;">'+t.cacNoDataText()+"</li>")),t.selector().data("AC_panel",n),n.appendTo(document.body);return this._inited||(this._inited=!0,n.css({width:t.cacBoxWidth()+"px"})),n},initPopupData:function(e){this.initData=e},verifyKey:function(){if(!this.cacStrictData())return;var t=this,n=this.selector().val().trim(),r=[],i=t.selector().is("[cacIdKey]"),s;if(!n){t.selector().val(""),t.setIdSelectorData();return}if(n){var o=t.cacIdVal(),u,a;e.each(t.initData,function(e,f){if(i){var l=f.label.trim();l===n&&(s=!0,!a&&t.setIdSelectorData(f.id),a=!0),l===n&&!o&&t.setIdSelectorData(o=f.id);if(l===n&&f.id===o)return r.push(f),!u&&t.setIdSelectorData(f.id),u=!0,s=!0,!1}else f.label.trim()==n&&(r.push(f),s=!0)})}s||(t.selector().val(""),t.setIdSelectorData())},cache:function(e){return JC.log("................cache",e),e in this._cache||(this._cache[e]=this.keyData(e)||this.initData),this._cache[e]},dataItems:function(){var t=this,n=t.listItems(),r=[];return n.each(function(n,i){var s=e(this);r.push({id:s.attr(t.cacIdKey())||"",label:s.attr(t.cacLabelKey())})}),r},ajaxData:function(n,r){var i=this,n=n||i.attrProp("cacAjaxDataUrl");if(!n)return;if(n in t.Model.AJAX_CACHE){e(i).trigger("TriggerEvent",[t.Model.UPDATE,t.Model.AJAX_CACHE[n],r]);return}e.get(n).done(function(s){s=e.parseJSON(s),s=i.cacDataFilter(s),t.Model.AJAX_CACHE[n]=s,e(i).trigger("TriggerEvent",[t.Model.UPDATE,t.Model.AJAX_CACHE[n],r])})},keyData:function(t){var n=this,r=n.initData,i=0,s=n.cacCasesensitive(),o=t.toLowerCase(),u=[[],[],[],[]],a=[];for(i=0;i<r.length;i++){var f=r[i].label.toLowerCase();r[i].label.indexOf(t)==0?u[r[i].tag=0].push(r[i]):!s&&f.indexOf(o)==0?u[r[i].tag=1].push(r[i]):r[i].label.indexOf(t)>0?u[r[i].tag=2].push(r[i]):!s&&f.indexOf(o)>0&&u[r[i].tag=3].push(r[i])}return e.each(u,function(e,t){a=a.concat(t)}),a},setSelectorData:function(t){t&&(t=e(t));if(!t||!t.length)return;var n=this,r=t.attr(n.cacLabelKey()).trim(),i=t.attr(n.cacIdKey()).trim();n.selector().val(r),n.selector().attr("cacIdVal",i),n.setIdSelectorData(i)},setIdSelectorData:function(e){var t=this;if(!t.cacIdSelector()||!t.cacIdSelector().length)return;typeof e!="undefined"?(t.cacIdSelector().val(e),t.selector().attr("cacIdVal",e)):(t.cacIdSelector().val(""),t.selector().attr("cacIdVal",""))},listItems:function(){var e;return this.popup()&&this.popup().length&&(e=this.popup().find(this.cacSubItemsSelector())),e},selectedItem:function(){var n;return this.listItems().each(function(){var r=e(this);if(r.hasClass(t.Model.CLASS_ACTIVE))return n=r,!1}),n},keyupTimeout:function(e){this._keyupTimeout&&clearTimeout(this._keyupTimeout),this._keyupTimeout=e},keydownTimeout:function(e){this._keydownTimeout&&clearTimeout(this._keydownTimeout),this._keydownTimeout=e},blurTimeout:function(e){this._blurTimeout&&clearTimeout(this._blurTimeout),this._blurTimeout=e},cacDataFilter:function(e){var n=this.callbackProp("cacDataFilter")||t.dataFilter;return n&&(e=n(e)),e},cacNoDataText:function(){var e=this.attrProp("cacNoDataText")||"数据加载中, 请稍候...";return e},cacValidCheckTimeout:function(){var e=this.intProp("cacValidCheckTimeout")||t.validCheckTimeout||1;return e},cacStrictData:function(){var e=this.boolProp("cacStrictData");return e},cacLabelKey:function(){var e=this.attrProp("cacLabelKey")||"data-label";return e},cacIdKey:function(e){typeof e!="undefined"&&this.selector().attr("cacIdKey",e);var t=this.attrProp("cacIdKey")||this.cacLabelKey();return t},cacIdVal:function(){var e=this,t=e.attrProp("cacIdVal");return e.cacIdSelector()&&e.cacIdSelector().length&&(t=e.cacIdSelector().val()),t=(t||"").trim(),t},cacIdSelector:function(){var e=this.selectorProp("cacIdSelector");return e},cacPreventEnter:function(){var e;return e=this.selector().is("[cacPreventEnter]")&&JC.f.parseBool(this.selector().attr("cacPreventEnter")),e},cacBoxWidth:function(){var e=this.intProp("cacBoxWidth");return!e&&(e=this.selector().width()),e},cacCasesensitive:function(){return this.boolProp("cacCasesensitive")},cacSubItemsSelector:function(){var e=this.attrProp("cacSubItemsSelector")||"> li";return e+="["+this.cacLabelKey()+"]",e}}),JC.f.extendObject(t.View.prototype,{init:function(){var n=this;n._model.listItems().each(function(t){e(this).attr("data-index",t)}).removeClass(t.Model.CLASS_ACTIVE).first().addClass(t.Model.CLASS_ACTIVE)},hide:function(){var e=this;e._model.popup().hide()},show:function(){var n=this,r=n._model.selector().offset(),i=n._model.selector().prop("offsetHeight"),s=n._model.selector().prop("offsetWidth");n._model.popup().css({top:r.top+i+"px",left:r.left+"px"});var o,u=n._model.selector().val().trim(),a=n._model.cacIdVal(),f=n._model.cacLabelKey()!=n._model.cacIdKey();n._model.listItems().each(function(){var r=e(this),i=r.attr(n._model.cacLabelKey()),s=r.attr(n._model.cacIdKey());r.removeClass(t.Model.CLASS_ACTIVE),u==i&&(f&&a?(a==s&&r.addClass(t.Model.CLASS_ACTIVE),o=r):(r.addClass(t.Model.CLASS_ACTIVE),o=r))}),o||n._model.listItems().first().addClass(t.Model.CLASS_ACTIVE),n._model.popup().show()},updateList:function(){var e=this,t,n=[],r=e._model.selector().val().trim(),i=e._model.cacIdVal(),s;r?s=e._model.cache(r,i):s=e._model.initData,s&&e.build(s)},build:function(e){var n=this,r=0,i=[];if(e.length==0)n.hide();else{for(;r<e.length;r++)i.push(JC.f.printf(n._model.listItemTpl(),e[r].id,e[r].label,r,r===0?t.Model.CLASS_ACTIVE:""));n._model.popup().html(i.join(""))}},currentIndex:function(n){var r=this,i=r._model.popup(),s=r._model.listItems(),o=-1;if(!s.length)return;return s.each(function(n){var r=e(this);if(r.hasClass(t.Model.CLASS_ACTIVE))return o=n,!1}),o<0?o=n?0:s.length-1:(o=n?o+1:o-1,o<0?o=s.length-1:o>=s.length&&(o=0)),o},updateListIndex:function(e){var t=this,n=t.currentIndex(e);t.updateIndex(n)},updateIndex:function(n,r){var i=this,s=i._model.listItems();i.removeActiveClass(),e(s[n]).addClass(t.Model.CLASS_ACTIVE),!r&&i.setScroll(n)},setScroll:function(e){var n=this,r=n._model.listItems().eq(e),i=r.position().top+r.height(),s=n._model.popup().innerHeight(),o=n._model.popup().scrollTop();i+=o,e==-1?(n._model.selector().focus(),n._model.listItems().removeClass(t.Model.CLASS_ACTIVE)):(n._model.listItems().removeClass(t.Model.CLASS_ACTIVE),r.addClass(t.Model.CLASS_ACTIVE),i>s&&n._model.popup().scrollTop(i-s),r.position().top<0&&n._model.popup().scrollTop(0)),t.Model.SCROLL_TIMEOUT&&clearTimeout(t.Model.SCROLL_TIMEOUT),t.Model.SCROLL_TIMEOUT=setTimeout(function(){t.Model.isScroll=!1},500)},removeActiveClass:function(){this._model.listItems().removeClass(t.Model.CLASS_ACTIVE)}}),e.event.special[t.Model.REMOVE]={remove:function(e){e.handler&&e.handler()}},e(window).on("resize",function(n){e("input.js_compAutoComplete").each(function(){var n=t.getInstance(e(this));n&&n.fixPosition()})}),e(document).on("click",function(){e("ul.js_compAutoCompleteBox, div.js_compAutoCompleteBox").hide()}),e(document).delegate("input.js_compAutoComplete","focus",function(e){!t.getInstance(this)&&new t(this)})}(jQuery),JC.AutoComplete})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);