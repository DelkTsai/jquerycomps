(function(e,t){e(["JC.common"],function(){return function(e){function t(i){i&&(i=e(i));if(t.getInstance(i))return t.getInstance(i);t.getInstance(i,this),t._allIns.push(this),this._model=new n(i),this._view=new r(this._model),this._init()}function n(e){this._selector=e,this._id="Suggest_"+(new Date).getTime()}function r(e){this._model=e}window.JC=window.JC||{log:function(){}},window.Suggest=JC.Suggest=t,t.prototype={_init:function(){var t=this;return e([t._view,t._model]).on("BindEvent",function(e,n,r){t.on(n,r)}),e([t._view,t._model]).on("TriggerEvent",function(e,n,r){t.trigger(n,[r])}),t._view.init(),t._model.init(),t.selector().attr("autocomplete","off"),t._initActionEvent(),t.trigger("SuggestInited"),t},update:function(e,t){var n=this;typeof t=="undefined"&&(t=e),n._model.sugdatafilter()&&(t=n._model.sugdatafilter().call(this,t)),t&&t.q&&n._model.cache(t.q,t),this._view.update(t)},show:function(){return this._view.show(),this},hide:function(){return this._view.hide(),this},selector:function(){return this._model.selector()},layout:function(){return this._model.layout()},on:function(t,n){return e(this).on(t,n),this},trigger:function(t,n){return e(this).trigger(t,n),this},_initActionEvent:function(){var n=this;n.on("SuggestUpdate",n.update),n.on("SuggestInited",function(e){n._model.suginitedcallback()&&n._model.suginitedcallback().call(n)}),n._model.selector().on("keyup",function(t){var r=e(this),i=r.val().trim(),s=t.keyCode,o=r.data("IgnoreTime");if(o&&(new Date).getTime()-o<300)return;JC.log("keyup",i,(new Date).getTime(),s);if(s)switch(s){case 38:case 40:t.preventDefault();case 37:case 39:return;case 27:n.hide();return}if(!i){n.update();return}if(!n._model.layout().is(":visible")&&n._model.cache(i)){n.update(n._model.cache(i));return}if(n._model.preValue===i)return;n._model.preValue=i;if(n._model.cache(i)){n.update(n._model.cache(i));return}JC.log(i),n._model.sugqueryinterval()?(n._model.timeout&&clearTimeout(n._model.timeout),n._model.timeout=setTimeout(function(){n._model.getData(i)},n._model.sugqueryinterval())):n._model.getData(i)}),n._model.selector().on("blur",function(e){n._model.timeout&&clearTimeout(n._model.timeout)}),n._model.selector().on("keydown",function(t){var r=t.keyCode,i=e(this),s,o,u=n._model.items(),a;r==38&&(o=!0),JC.log("keyup",(new Date).getTime(),r);switch(r){case 38:case 40:s=n._model.nextIndex(o);if(s>=0&&s<u.length){t.preventDefault(),a=e(u[s]),n._model.selectedIdentifier(a),n.selector().val(n._model.getKeyword(a));return}break;case 9:n.hide();return;case 13:n.hide(),i.data("IgnoreTime",(new Date).getTime()),n._model.sugprevententer()&&t.preventDefault()}}),e(n._model.layout()).delegate(".js_sugItem","mouseenter",function(t){n._model.selectedIdentifier(e(this),!0)}),e(n._model.layout()).delegate(".js_sugItem","mouseleave",function(t){e(this).removeClass("active")}),n.selector().on("click",function(e){e.stopPropagation(),n.selector().trigger("keyup"),t._hideOther(n)}),e(n._model.layout()).delegate(".js_sugItem","click",function(t){var r=e(this),i=n._model.getKeyword(r);n.selector().val(i),n.hide(),n.trigger("SuggestSelected",[r]),n._model.sugselectedcallback()&&n._model.sugselectedcallback().call(n,i),setTimeout(function(){n.selector().trigger("blur")},50)}),n._model.sugautoposition()&&e(window).on("resize",function(){n._model.layout().is(":visible")&&n._view.show()})}},t.getInstance=function(t,n){typeof t=="string"&&!/</.test(t)&&(t=e(t));if(!t||!t.length||typeof t=="string")return;return typeof n!="undefined"&&t.data("SuggestInstace",n),t.data("SuggestInstace")},t.isSuggest=function(t){var n;return t&&(t=e(t)).length&&(n=t.is("[sugurl]")||t.is("sugstaticdatacb")),n},t.autoInit=!0,t.layoutTpl="",t.layoutTpl="",t.dataFilter,t._allIns=[],t._hideOther=function(e){for(var n=0,r=t._allIns.length;n<r;n++)t._allIns[n]._model._id!=e._model._id&&t._allIns[n].hide()},n.prototype={init:function(){return this},selector:function(){return this._selector},suglayouttpl:function(){var e=this,n=t.layoutTpl||e.layoutTpl,r;return(r=e.selector().attr("suglayouttpl"))&&(n=r),n},layoutTpl:'<dl class="sug_layout js_sugLayout" style="display:none;"></dl>',layout:function(){var t=this;return!t._layout&&t.selector().is("[suglayout]")&&(t._layout=JC.f.parentSelector(t.selector(),t.selector().attr("suglayout"))),!t._layout&&(t._layout=e(t.suglayouttpl()),t._layout.hide(),t._layout.appendTo(document.body),t._sugautoposition=!0),!t._layout.hasClass("js_sugLayout")&&t._layout.addClass("js_sugLayout"),t.sugwidth()&&t._layout.css({width:t.sugwidth()+"px"}),t._layout.css({width:t._layout.width()+t.sugoffsetwidth()+"px"}),t._layout},sugautoposition:function(){return this.layout().is("sugautoposition")&&(this._sugautoposition=JC.f.parseBool(this.layout().attr("sugautoposition"))),this._sugautoposition},sugwidth:function(){return this.selector().is("[sugwidth]")&&(this._sugwidth=parseInt(this.selector().attr("sugwidth"))),!this._sugwidth&&(this._sugwidth=this.sugplaceholder().width()),this._sugwidth},sugoffsetleft:function(){return this.selector().is("[sugoffsetleft]")&&(this._sugoffsetleft=parseInt(this.selector().attr("sugoffsetleft"))),!this._sugoffsetleft&&(this._sugoffsetleft=0),this._sugoffsetleft},sugoffsettop:function(){return this.selector().is("[sugoffsettop]")&&(this._sugoffsettop=parseInt(this.selector().attr("sugoffsettop"))),!this._sugoffsettop&&(this._sugoffsettop=0),this._sugoffsettop},sugoffsetwidth:function(){return this.selector().is("[sugoffsetwidth]")&&(this._sugoffsetwidth=parseInt(this.selector().attr("sugoffsetwidth"))),!this._sugoffsetwidth&&(this._sugoffsetwidth=0),this._sugoffsetwidth},_dataCallback:function(t){e(this).trigger("TriggerEvent",["SuggestUpdate",t])},sugdatacallback:function(){var e=this;return this.selector().is("[sugdatacallback]")&&(this._sugdatacallback=this.selector().attr("sugdatacallback")),!this._sugdatacallback&&(this._sugdatacallback=e._id+"_cb"),!window[this._sugdatacallback]&&(window[this._sugdatacallback]=function(t){e._dataCallback(t)}),this._sugdatacallback},sugurl:function(e){return this.selector().is("[sugurl]")&&(this._sugurl=this.selector().attr("sugurl")),!this.selector().is("[sugurl]")&&(this._sugurl="?word={0}&callback={1}"),this._sugurl=JC.f.printf(this._sugurl,e,this.sugdatacallback()),this._sugurl},sugneedscripttag:function(){return this._sugneedscripttag=!0,this.selector().is("[sugneedscripttag]")&&(this._sugneedscripttag=JC.f.parseBool(this.selector().attr("sugneedscripttag"))),this._sugneedscripttag},getData:function(t){var n=this,r=this.sugurl(t),i,s="script_"+n._id;JC.log(r,(new Date).getTime()),this.sugneedscripttag()?(e("#"+s).remove(),i=JC.f.printf('<script id="{1}" src="{0}"></script>',r,s),e(i).appendTo(document.body)):e.get(r,function(t){t=e.parseJSON(t),n._dataCallback(t)})},cache:function(e,t){return this._cache=this._cache||{},typeof t!="undefined"&&(this._cache[e]=t),this._cache[e]},sugselectedcallback:function(){var e=this;return this.selector().is("[sugselectedcallback]")&&(this._sugselectedcallback=this.selector().attr("sugselectedcallback")),this._sugselectedcallback?window[this._sugselectedcallback]:null},suginitedcallback:function(){var e=this;return this.selector().is("[suginitedcallback]")&&(this._suginitedcallback=this.selector().attr("suginitedcallback")),this._suginitedcallback?window[this._suginitedcallback]:null},sugdatafilter:function(){var e=this;return this.selector().is("[sugdatafilter]")&&(this._sugdatafilter=this.selector().attr("sugdatafilter")),this._sugdatafilter=this._sugdatafilter||t.dataFilter,this._sugdatafilter?window[this._dataCallback]:null},sugqueryinterval:function(){return this.selector().is("[sugqueryinterval]")&&(this._sugqueryinterval=parseInt(this.selector().attr("sugqueryinterval"))),this._sugqueryinterval=this._sugqueryinterval||200,this._sugqueryinterval},sugprevententer:function(){var e;return this.selector().is("[sugprevententer]")&&(e=JC.f.parseBool(this.selector().attr("sugprevententer"))),e},timeout:null,preValue:null,keyindex:-1,nextIndex:function(e){var t=this.items(),n=t.length;return e?this.keyindex<=0?this.keyindex=n-1:this.keyindex--:this.keyindex>=n-1?this.keyindex=0:this.keyindex++,this.keyindex},items:function(){return this.layout().find(".js_sugItem")},selectedIdentifier:function(e,t){this._preSelected&&this._preSelected.removeClass("active"),e.addClass("active"),t&&(this.keyindex=parseInt(e.attr("keyindex"))),this._preSelected=e},getKeyword:function(e){var t=e.attr("keyword");try{t=decodeURIComponent(t)}catch(n){}return t},currentData:function(e){return typeof e!="undefined"&&(this._currentData=e),this._currentData},sugsubtagname:function(){var e="dd",t;return(t=this.selector().attr("sugsubtagname"))&&(e=t),e},sugplaceholder:function(){var e=this.selector();return this.selector().is("[sugplaceholder]")&&(e=JC.f.parentSelector(this.selector(),this.selector().attr("sugplaceholder"))),e}},r.prototype={init:function(){return this},show:function(){var t=this;e(this).trigger("TriggerEvent",["SuggestBeforeShow"]),this._model.layout().css("z-index",window.ZINDEX_COUNT++),this.autoposition(),this._model.layout().show(),setTimeout(function(){t._model.layout().show()},10),e(this).trigger("TriggerEvent",["SuggestShow"])},autoposition:function(){if(!this._model.sugautoposition())return;var e=this,t=e._model.sugplaceholder().offset(),n=e._model.sugplaceholder().height();e._model.layout().css({left:t.left+e._model.sugoffsetleft()+"px",top:t.top+e._model.sugoffsettop()+n+"px"})},hide:function(){this._model.layout().hide(),this.reset(),e(this).trigger("TriggerEvent",["SuggestHide"])},update:function(t){var n=this,r=[],i,s,o,u=n._model.sugsubtagname();if(!(t&&t.s&&t.s.length)){n.hide();return}for(var a=0,f=t.s.length;a<f;a++)s=t.s[a],o=s,i=t.q||"",o=o.replace(i,JC.f.printf("<b>{0}</b>",i)),r.push(JC.f.printf('<{4} keyword="{2}" keyindex="{3}" class="js_sugItem">{1}</{4}>',i,o,encodeURIComponent(s),a,u));n._model.layout().html(r.join("")),JC.log("suggest update"),this.reset(),n._model.currentData(t),e(this).trigger("TriggerEvent",["SuggestUpdated"]),n.show()},reset:function(){JC.log("suggest reset"),this._model.keyindex=-1,this._model.layout().find(".js_sugItem").removeClass("active"),e(this).trigger("TriggerEvent",["SuggestReset"])}},e(document).delegate("input[type=text]","focus",function(n){var r=e(this),i=t.getInstance(r);if(i||!t.isSuggest(r)||!t.autoInit)return;JC.log("Suggest input fined:",r.attr("name"),(new Date).getTime()),i=new t(r)}),e(document).on("click",function(t){e("dl.js_sugLayout, div.js_sugLayout").hide()})}(jQuery),JC.Suggest})})(typeof define=="function"&&define.amd?define:function(e,t){t&&t()},this);