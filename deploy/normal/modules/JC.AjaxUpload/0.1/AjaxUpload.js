(function(e,t){e(["JC.BaseMVC","JC.Panel"],function(){function t(e){if(t.getInstance(e))return t.getInstance(e);if(!e.hasClass("js_compAjaxUpload"))return t.init(e);t.getInstance(e,this),this._model=new t.Model(e),this._view=new t.View(this._model),JC.log("AjaxUpload init",(new Date).getTime()),this._init()}return JC.AjaxUpload=t,t.getInstance=function(e,n){typeof e=="string"&&!/</.test(e)&&(e=$(e));if(!e||!e.length||typeof e=="string")return;return typeof n!="undefined"&&e.data(t.Model._instanceName,n),e.data(t.Model._instanceName)},t.init=function(e){var n=[];return e=$(e||document),e.hasClass("js_compAjaxUpload")?n.push(new t(e)):e.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){n.push(new t($(this)))}),n},t.frameFileName="default.html",t.randomFrame=!1,t._FRAME_DIR="modules/JC.AjaxUpload/0.1/frame/",e&&!e.amd&&(t._FRAME_DIR="comps/AjaxUpload/frame/"),t._INS_COUNT=1,BaseMVC.build(t),JC.f.extendObject(t.prototype,{_beforeInit:function(){var e=this;JC.log("AjaxUpload _beforeInit",(new Date).getTime())},_initHanlderEvent:function(){var e=this;e.on("FrameLoad",function(t){var n=e._model.frame().prop("contentWindow");if(!n||!n.initPage)return;n.initPage(e,e._model);if(e._model.INITED)return;e._model.INITED=!0,e._model.cauDefaultHide()&&setTimeout(function(){e._model.frame().hide(),e._model.selector().hide()},1),e._model.selector().on("show",function(e){JC.log("show")}),e._model.selector().on("hide",function(e){JC.log("hide")}),e._model.frame().on("show",function(e){JC.log("show")}),e._model.frame().on("hide",function(e){JC.log("hide")})}),e.on("ERR_FILE_EXT",function(t,n){e._view.errFileExt(n),e._view.updateChange()}),e.on("BeforeUpload",function(t){e._view.beforeUpload()}),e.on("UploadDone",function(t,n,r){if(r)return;JC.log(n);var i=!1,s=n;try{typeof n=="string"&&(n=$.parseJSON(n))}catch(o){n={},i=!0}i?(e._view.errFatalError(s),e._view.updateChange(),e._model.cauUploadErrorCallback()&&e._model.cauUploadErrorCallback().call(e,n,e._model.selector(),e._model.frame())):(n.errorno?(e._view.errUpload(n),e._view.updateChange()):e._view.updateChange(n),e._model.cauUploadDoneCallback()&&e._model.cauUploadDoneCallback().call(e,n,e._model.selector(),e._model.frame()))}),e.on("AUUpdateLayout",function(t,n,r,i){e._view.updateLayout(n,r,i)})},_inited:function(){var e=this;JC.log("AjaxUpload _inited",(new Date).getTime()),e._view.loadFrame(),t.getInstance(e._model.frame(),e),e.trigger("AUInited")},update:function(e){var t=this;return $(t._view).trigger("UpdateDefaultStatus"),e&&t.trigger("UploadDone",[e]),this}}),t.Model._instanceName="AjaxUpload",JC.f.extendObject(t.Model.prototype,{init:function(){JC.log("AjaxUpload.Model.init:",(new Date).getTime())},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileName:function(){return this.attrProp("cauFileName")||this.attrProp("name")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauSaveLabelSelector:function(){var e=this.selectorProp("cauSaveLabelSelector");return e},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauHideButton:function(){var e=!1;return this.is("[cauHideButton]")&&(e=this.boolProp(this.attrProp("cauHideButton"))),e},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},cauJSONPName:function(){var e=t.JSONPName;return e=JC.f.getUrlParam(this.cauUrl(),"callback")||e,e=this.attrProp("cauJSONPName")||e,e},framePath:function(){var e=this.attrProp("cauFrameFileName")||t.frameFileName,n=JC.f.printf("{0}{1}{2}",JC.PATH,t._FRAME_DIR,e);return this.randomFrame()&&(n=JC.f.addUrlParams(n,{rnd:(new Date).getTime()})),n},randomFrame:function(){var e=t.randomFrame;return this.selector().is("[cauRandomFrame]")&&(e=this.boolProp("cauRandomFrame")),e},frame:function(){if(!this._iframe){var e=t.frameTpl;this.selector().is("[cauFrameScriptTpl]")&&(e=JC.f.scriptContent(JC.f.parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))),this._iframe=$(t.frameTpl)}return this._iframe}}),JC.f.extendObject(t.View.prototype,{init:function(){JC.log("AjaxUpload.View.init:",(new Date).getTime());var e=this;$(e).on("UpdateDefaultStatus",function(t){var n=e._model.cauStatusLabel(),r=e._model.cauDisplayLabel();e.updateChange(),e._model.frame().show(),n&&n.length&&n.hide(),r&&r.length&&r.hide(),(e._model.selector().attr("type")||"").toLowerCase()!="hidden"&&e._model.selector().show()}),$(e).on("CAUUpdate",function(t,n){var r=e._model.cauDisplayLabel(),i="",s="";typeof n!="undefined"&&(s=n.data[e._model.cauValueKey()],i=n.data[e._model.cauLabelKey()],e._model.selector().val(s),e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val(i)),e._model.cauDisplayLabelCallback()?i=e._model.cauDisplayLabelCallback().call(e._model.selector(),n,i,s):i=JC.f.printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',s,i),r&&r.length&&r.html(i)})},loadFrame:function(){var e=this,t=e._model.framePath(),n=e._model.frame();JC.log(t),n.attr("src",t),n.on("load",function(){e.trigger("FrameLoad")}),e._model.selector().before(n)},beforeUpload:function(){var e=this,t=e._model.cauStatusLabel();JC.log("AjaxUpload view#beforeUpload",(new Date).getTime()),this.updateChange(null,!0),t&&t.length&&(e._model.selector().hide(),e._model.frame().hide(),t.show())},updateChange:function(e,t){var n=this,r=n._model.cauStatusLabel(),i=n._model.cauDisplayLabel();r&&r.length&&!t&&(n._model.selector().show(),n._model.frame().show(),r.hide()),i&&i.length&&i.html(""),n._model.selector().val(""),n._model.cauSaveLabelSelector()&&n._model.cauSaveLabelSelector().val("");if(e&&"errorno"in e&&!e.errorno){$(n).trigger("CAUUpdate",[e]),n._model.selector().val()&&n._model.selector().is(":visible")&&n._model.selector().prop("type").toLowerCase()=="text"&&n._model.selector().trigger("blur");if(i&&i.length){n._model.selector().hide(),n._model.is("[cauHideButton]")?n._model.cauHideButton()&&n._model.frame().hide():n._model.frame().hide(),i.show();return}}},updateLayout:function(e,t,n){if(!e||!t)return;var r=this;JC.log("AjaxUpload @event UpdateLayout",(new Date).getTime(),e,t),r._model.frame().css({width:e+"px",height:t+"px"})},errUpload:function(e){var t=this,n=t._model.callbackProp("cauUploadErrCallback");if(n)n.call(t._model.selector(),e,t._model.frame());else{var r=e&&e.errmsg?e.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFileExt:function(e){var t=this,n=t._model.callbackProp("cauFileExtErrCallback");if(n)n.call(t._model.selector(),t._model.cauFileExt(),e,t._model.frame());else{var r=JC.f.printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',t._model.cauFileExt(),e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFatalError:function(e){var t=this,n=t._model.callbackProp("cauFatalErrorCallback");if(n)n.call(t._model.selector(),e,t._model.frame());else{var r=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}}}),$.event.special.AjaxUploadShowEvent={show:function(e){e.handler&&e.handler()}},t.frameTpl=JC.f.printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;"),$(document).ready(function(){t.autoInit&&t.init()}),JC.AjaxUpload})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);