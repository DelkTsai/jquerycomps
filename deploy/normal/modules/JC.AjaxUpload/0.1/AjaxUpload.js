(function(e,t){e(["JC.BaseMVC","JC.Panel"],function(){return function(t){function n(e){if(n.getInstance(e))return n.getInstance(e);if(!e.hasClass("js_compAjaxUpload"))return n.init(e);n.getInstance(e,this),this._model=new n.Model(e),this._view=new n.View(this._model),JC.log("AjaxUpload init",(new Date).getTime()),this._init()}window.JC=window.JC||{log:function(){}},JC.AjaxUpload=n,n.getInstance=function(e,r){typeof e=="string"&&!/</.test(e)&&(e=t(e));if(!e||!e.length||typeof e=="string")return;return typeof r!="undefined"&&e.data(n.Model._instanceName,r),e.data(n.Model._instanceName)},n.init=function(e){var r=[];return e=t(e||document),e.hasClass("js_compAjaxUpload")?r.push(new n(e)):e.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){r.push(new n(t(this)))}),r},n.frameFileName="default.html",n.randomFrame=!1,n._FRAME_DIR="modules/JC.AjaxUpload/0.1/frame/",e&&!e.amd&&(n._FRAME_DIR="comps/AjaxUpload/frame/"),n._INS_COUNT=1,n.prototype={_beforeInit:function(){var e=this;JC.log("AjaxUpload _beforeInit",(new Date).getTime())},_initHanlderEvent:function(){var e=this;e.on("FrameLoad",function(t){var n=e._model.frame().prop("contentWindow");if(!n||!n.initPage)return;n.initPage(e,e._model);if(e._model.INITED)return;e._model.INITED=!0,e._model.cauDefaultHide()&&setTimeout(function(){e._model.frame().hide(),e._model.selector().hide()},1),e._model.selector().on("show",function(e){JC.log("show")}),e._model.selector().on("hide",function(e){JC.log("hide")}),e._model.frame().on("show",function(e){JC.log("show")}),e._model.frame().on("hide",function(e){JC.log("hide")})}),e.on("ERR_FILE_EXT",function(t,n){e._view.errFileExt(n),e._view.updateChange()}),e.on("BeforeUpload",function(t){e._view.beforeUpload()}),e.on("UploadDone",function(n,r){JC.log(r);var i=!1,s=r;try{typeof r=="string"&&(r=t.parseJSON(r))}catch(o){r={},i=!0}i?(e._view.errFatalError(s),e._view.updateChange(),e._model.cauUploadErrorCallback()&&e._model.cauUploadErrorCallback().call(e,r,e._model.selector(),e._model.frame())):(r.errorno?(e._view.errUpload(r),e._view.updateChange()):e._view.updateChange(r),e._model.cauUploadDoneCallback()&&e._model.cauUploadDoneCallback().call(e,r,e._model.selector(),e._model.frame()))}),e.on("AUUpdateLayout",function(t,n,r,i){e._view.updateLayout(n,r,i)})},_inited:function(){var e=this;JC.log("AjaxUpload _inited",(new Date).getTime()),e._view.loadFrame(),n.getInstance(e._model.frame(),e),e.trigger("AUInited")},update:function(e){var n=this;return t(n._view).trigger("UpdateDefaultStatus"),e&&n.trigger("UploadDone",[e]),this}},BaseMVC.buildModel(n),n.Model._instanceName="AjaxUpload",n.Model.prototype={init:function(){JC.log("AjaxUpload.Model.init:",(new Date).getTime())},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileName:function(){return this.attrProp("cauFileName")||this.attrProp("name")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauSaveLabelSelector:function(){var e=this.selectorProp("cauSaveLabelSelector");return e},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauHideButton:function(){var e=!1;return this.is("[cauHideButton]")&&(e=this.boolProp(this.attrProp("cauHideButton"))),e},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},framePath:function(){var e=this.attrProp("cauFrameFileName")||n.frameFileName,t=JC.f.printf("{0}{1}{2}",JC.PATH,n._FRAME_DIR,e);return this.randomFrame()&&(t=JC.f.addUrlParams(t,{rnd:(new Date).getTime()})),t},randomFrame:function(){var e=n.randomFrame;return this.selector().is("[cauRandomFrame]")&&(e=this.boolProp("cauRandomFrame")),e},frame:function(){if(!this._iframe){var e=n.frameTpl;this.selector().is("[cauFrameScriptTpl]")&&(e=JC.f.scriptContent(JC.f.parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))),this._iframe=t(n.frameTpl)}return this._iframe}},BaseMVC.buildView(n),n.View.prototype={init:function(){JC.log("AjaxUpload.View.init:",(new Date).getTime());var e=this;t(e).on("UpdateDefaultStatus",function(t){var n=e._model.cauStatusLabel(),r=e._model.cauDisplayLabel();e.updateChange(),e._model.frame().show(),n&&n.length&&n.hide(),r&&r.length&&r.hide(),(e._model.selector().attr("type")||"").toLowerCase()!="hidden"&&e._model.selector().show()}),t(e).on("CAUUpdate",function(t,n){var r=e._model.cauDisplayLabel(),i="",s="";typeof n!="undefined"&&(s=n.data[e._model.cauValueKey()],i=n.data[e._model.cauLabelKey()],e._model.selector().val(s),e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val(i)),e._model.cauDisplayLabelCallback()?i=e._model.cauDisplayLabelCallback().call(e._model.selector(),n,i,s):i=JC.f.printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',s,i),r&&r.length&&r.html(i)})},loadFrame:function(){var e=this,n=e._model.framePath(),r=e._model.frame();JC.log(n),r.attr("src",n),r.on("load",function(){t(e).trigger("TriggerEvent","FrameLoad")}),e._model.selector().before(r)},beforeUpload:function(){var e=this,t=e._model.cauStatusLabel();JC.log("AjaxUpload view#beforeUpload",(new Date).getTime()),this.updateChange(null,!0),t&&t.length&&(e._model.selector().hide(),e._model.frame().hide(),t.show())},updateChange:function(e,n){var r=this,i=r._model.cauStatusLabel(),s=r._model.cauDisplayLabel();i&&i.length&&!n&&(r._model.selector().show(),r._model.frame().show(),i.hide()),s&&s.length&&s.html(""),r._model.selector().val(""),r._model.cauSaveLabelSelector()&&r._model.cauSaveLabelSelector().val("");if(e&&"errorno"in e&&!e.errorno){t(r).trigger("CAUUpdate",[e]),r._model.selector().val()&&r._model.selector().is(":visible")&&r._model.selector().prop("type").toLowerCase()=="text"&&r._model.selector().trigger("blur");if(s&&s.length){r._model.selector().hide(),r._model.is("[cauHideButton]")?r._model.cauHideButton()&&r._model.frame().hide():r._model.frame().hide(),s.show();return}}},updateLayout:function(e,t,n){if(!e||!t)return;var r=this;JC.log("AjaxUpload @event UpdateLayout",(new Date).getTime(),e,t),r._model.frame().css({width:e+"px",height:t+"px"})},errUpload:function(e){var t=this,n=t._model.callbackProp("cauUploadErrCallback");if(n)n.call(t._model.selector(),e,t._model.frame());else{var r=e&&e.errmsg?e.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFileExt:function(e){var t=this,n=t._model.callbackProp("cauFileExtErrCallback");if(n)n.call(t._model.selector(),t._model.cauFileExt(),e,t._model.frame());else{var r=JC.f.printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',t._model.cauFileExt(),e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFatalError:function(e){var t=this,n=t._model.callbackProp("cauFatalErrorCallback");if(n)n.call(t._model.selector(),e,t._model.frame());else{var r=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}}},BaseMVC.build(n),t.event.special.AjaxUploadShowEvent={show:function(e){e.handler&&e.handler()}},n.frameTpl=JC.f.printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;"),t(document).ready(function(){n.autoInit&&n.init()})}(jQuery),JC.AjaxUpload})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);