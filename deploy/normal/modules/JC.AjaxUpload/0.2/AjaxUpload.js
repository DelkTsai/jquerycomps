(function(e,t){e(["JC.BaseMVC","JC.Panel","SWFUpload"],function(){function e(t){if(e.getInstance(t))return e.getInstance(t);if(!t.hasClass("js_compAjaxUpload"))return e.init(t);e.getInstance(t,this),this._model=new e.Model(t),this._view=new e.View(this._model),JC.log("AjaxUpload init",(new Date).getTime()),this._init()}function t(e,t){var n=t?1e3:1024;if(e<n)return e+" B";var r=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],i=-1;do e/=n,++i;while(e>=n);return e.toFixed(1)+" "+r[i]}function n(e){return e.replace(/[^\x00-\xff]/g,"11").length}return JC.AjaxUpload=e,e.getInstance=function(t,n){typeof t=="string"&&!/</.test(t)&&(t=$(t));if(!t||!t.length||typeof t=="string")return;return typeof n!="undefined"&&t.data(e.Model._instanceName,n),t.data(e.Model._instanceName)},e.init=function(t){var n=[];return t=$(t||document),t.hasClass("js_compAjaxUpload")?n.push(new e(t)):t.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){n.push(new e($(this)))}),n},e.paramsCallback,BaseMVC.build(e),JC.f.extendObject(e.prototype,{_beforeInit:function(){var e=this},_initHanlderEvent:function(){var e=this;e.on("ERR_FILE_EXT",function(t,n){e._view.errFileExt(n),e._view.updateChange()}),e.on("BeforeUpload",function(t){e._view.beforeUpload()}),e.on("UploadDone",function(t,n,r,i){if(r)return;var s=!1,o=n;try{typeof n=="string"&&(n=$.parseJSON(n))}catch(u){n={},s=!0}e.trigger("UploadComplete"),s?(e._view.errFatalError(o),e.trigger("UpdateDefaultStatus"),e._model.cauUploadErrorCallback()&&e._model.cauUploadErrorCallback().call(e,n,e._model.selector())):(n.errorno?(e._view.errUpload(n),e._view.updateChange()):e._view.updateChange(n),e._model.cauUploadDoneCallback()&&e._model.cauUploadDoneCallback().call(e,n,e._model.selector()))}),e.on("UpdateDefaultStatus",function(t,n,r,i){JC.f.safeTimeout(function(){$(e._view).trigger("UpdateDefaultStatus",[n,r,i])},e,"RESET_STATUS",100)}),e.on("UploadError",function(t,n,r,i){$(e._view).trigger("UploadError",[n,r,i])}),e.on("CancelUpload",function(t){e._model.cancelUpload(),e.trigger("UploadComplete"),e._model.cauCancelCallback()&&e._model.cauCancelCallback().call(e)}),e.on("UploadComplete",function(t,n){e._view.uploadComplete(n)}),e.on("UploadProgress",function(t,n,r,i){e._view.uploadProgress(n.name,r,i)}),e.on("inited",function(){e._model.loadSWF(e._model.getParams())}),e.on("disable",function(){e._model.uploadReady()||e._model.beforeReadyQueue(function(){e._view.disable()}),e._view.disable()}),e.on("enable",function(){e._model.uploadReady()||e._model.beforeReadyQueue(function(){e._view.enable()}),e._view.enable()}),e.on("UploadReady",function(){var t=e._model.beforeReadyQueue();setTimeout(function(){$.each(t,function(e,t){t()})},300)})},_inited:function(){var e=this;$(document).delegate(JC.f.printf(".AjaxUploadProgressBox_{0} .AUCancelProgress",e._model.id()),"click",function(t){e.trigger("CancelUpload")}),e.trigger("inited")},disable:function(){return this.trigger("disable"),this},enable:function(){return this.trigger("enable"),this},update:function(e){var t=this;return t.trigger("UpdateDefaultStatus"),e&&t.trigger("UploadDone",[e]),this}}),e.Model._instanceName="AjaxUpload",e.Model._insCount=1,JC.use?(e.Model.FLASH_URL="/plugins/SWFUpload.swf",e.Model.PATH="/comps/AjaxUpload/"):(e.Model.FLASH_URL="/modules/SWFUpload/2.5.0/SWFUpload.swf",e.Model.PATH="/modules/JC.AjaxUpload/0.2/"),e.Model.PROGRESS_TPL=['<span class="AUProgressBox" style="display:none;">','<button type="button" class="AUProgress"><div class="AUPercent"></div></button>','<button type="button" class="AUCancelProgress"></button>',"</span>"].join(""),JC.f.extendObject(e.Model.prototype,{init:function(){this._id=e.Model._insCount++},id:function(){return this._id},cauStyle:function(){return this.attrProp("cauStyle")||"g1"},cauButtonText:function(){return this.attrProp("cauButtonText")||"上传文件"},cauUrl:function(){return this.attrProp("cauUrl")},cauCancelCallback:function(){return this.callbackProp("cauCancelCallback")},cauFileExt:function(){var e=this.stringProp("cauFileExt")||this.stringProp("fileext")||this.stringProp("file_types");return e&&(e=e.replace(/[\s]+/g,"")),e&&!/[\*]/.test(e)&&(e=e.split(","),$.each(e,function(t,n){e[t]="*"+n}),e=e.join(";")),e},beforeReadyQueue:function(e){return!this._beforeReadyQueue&&(this._beforeReadyQueue=[]),typeof e!="undefined"&&this._beforeReadyQueue.push(e),this._beforeReadyQueue},uploadReady:function(e){return typeof e!="undefined"&&(this._uploadReady=e),this._uploadReady},cauFileName:function(){return this.attrProp("cauFileName")||this.attrProp("name")||"file"},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauSaveLabelSelector:function(){var e=this.selectorProp("cauSaveLabelSelector");return e},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},cauDebug:function(){return this.boolProp("cauDebug")},cauFlashUrl:function(){var t=this.attrProp("cauFlashUrl");return!t&&(t=JC.PATH+e.Model.FLASH_URL),t},cauButtonWidth:function(){var e=this.cauButtonText();return this.intProp("cauButtonWidth")||n(e)*7+20},cauButtonHeight:function(e){return this.intProp("cauButtonHeight")||e||22},cauButtonStyle:function(e){return this.attrProp("cauButtonStyle")||this.attrProp("button_text_style")||e||".uFont{ color:#000000; text-align: center; }"},layoutButton:function(){var e=this,t="AjaxUpload_hl_"+e.id();return this._buttonLayout||(e._buttonLayout=$(JC.f.printf('<button type="text" class="AUBtn AUBtn-{1} js_btn"><span id="{0}"></span></button>',t,e.cauStyle())),e.selector().after(this._buttonLayout)),this._buttonLayout},cauRoot:function(){var t=this.attrProp("cauRoot");return!t&&(t=JC.f.fixPath(JC.PATH+e.Model.PATH)),t},cauUploadLimit:function(){return this.intProp("cauUploadLimit")||this.intProp("file_upload_limit")||0},cauQueueLimit:function(){return this.intProp("cauQueueLimit")||this.intProp("file_queue_limit")||0},cauFileSize:function(){return this.attrProp("file_size_limit")||this.attrProp("cauFileSize")||"1024 MB"},cauCacheSwf:function(){var e=!0;return this.attrProp("prevent_swf_caching")&&(e=!this.boolProp("prevent_swf_caching")),this.attrProp("cauCacheSwf")&&(e=this.boolProp("cauCacheSwf")),e=!e,e},cauHttpSuccess:function(){var e=[200,201,204],t=this.attrProp("cauHttpSuccess")||this.attrProp("http_success");return t&&(e=t.replace(/[\s]+/g,"").split(",")),e},cauBatchUpload:function(){return this.boolProp("cauBatchUpload")},getParams:function(){var e=this,t={},n=e.cauFileExt();return e.layoutButton(),t.debug=e.cauDebug(),t.flash_url=JC.f.fixPath(e.cauFlashUrl()),t.upload_url=e.cauUrl(),t.file_post_name=e.cauFileName(),e.initButtonStyle(t),t.button_placeholder_id=e.layoutButton().find("> span[id]").attr("id"),t.button_text=JC.f.printf('<span class="uFont">{0}</span>',e.cauButtonText()),t.button_window_mode=SWFUpload.WINDOW_MODE.TRANSPAREN,t.button_cursor=SWFUpload.CURSOR.HAND,t.button_action=e.cauBatchUpload()?SWFUpload.BUTTON_ACTION.SELECT_FILES:SWFUpload.BUTTON_ACTION.SELECT_FILE,t.file_upload_limit=e.cauUploadLimit(),t.file_queue_limit=e.cauQueueLimit(),t.file_size_limit=e.cauFileSize(),t.prevent_swf_caching=e.cauCacheSwf(),t.http_success=e.cauHttpSuccess(),n&&(t.file_types=n),t.swfupload_loaded_handler=function(){e.swfu(this),e.uploadReady(!0),e.trigger("UploadReady")},t.file_dialog_start_handler=function(){JC.hideAllPopup(1)},t.file_dialog_complete_handler=function(t){if(e.beforeUploadError()){e.beforeUploadError(!1);return}if(!t)return;e.trigger("BeforeUpload"),this.startUpload(),this.setButtonDisabled(!0)},t.upload_progress_handler=function(t,n,r){e.trigger("UploadProgress",[t,n,r])},t.upload_error_handler=function(t,n,r){e.trigger("UpdateDefaultStatus"),e.trigger("UploadError",[t,n,r]),e.cauButtonAutoStatus()&&this.setButtonDisabled(!1)},t.upload_success_handler=function(t,n,r){e.trigger("UploadDone",[n,!1,t.name])},t.upload_complete_handler=function(t){e.cauButtonAutoStatus()&&this.setButtonDisabled(!1)},t.file_queue_error_handler=function(t,n,r){e.trigger("UpdateDefaultStatus"),e.trigger("UploadError",[t,n,r]),e.cauButtonAutoStatus()&&this.setButtonDisabled(!1)},this.cauParamsCallback()&&(t=this.cauParamsCallback().call(this,t)),e.is("[cauPostParams]")&&(t.post_params=e.jsonProp("cauPostParams")),JC.dir(t),t},cauButtonAutoStatus:function(){var e=!0;return this.is("[cauButtonAutoStatus]")&&(e=this.boolProp("cauButtonAutoStatus")),e},beforeUploadError:function(e){return typeof e!="undefined"&&(this._beforeUploadError=e),this._beforeUploadError},loadSWF:function(e){this._swfu&&this._swfu.destory(),new SWFUpload(e)},swfu:function(e){return typeof e!="undefined"&&(this._swfu=e),this._swfu},cauParamsCallback:function(){return this.callbackProp("cauParamsCallback")||e.paramsCallback||JC.AjaxUploadParamsCallback},cancelUpload:function(){this._swfu&&this._swfu.cancelUpload()},cauShowProgress:function(){var e=this.boolProp("cauShowProgress");return!e&&this.cauProgressBox()&&(e=this.cauProgressBox().length),e},cauProgressBox:function(){var t=this._cauProgressBox||this.selectorProp("cauProgressBox");return(!t||!t.length)&&this.boolProp("cauShowProgress")&&(t=this._cauProgressBox=$(e.Model.PROGRESS_TPL),this.selector().after(t)),t&&t.length&&!this._initedProgressBox&&(t.addClass("AjaxUploadProgressBox_"+this.id()),this._initedProgressBox=!0),t},initButtonStyle:function(e){if(!e)return;var t=this,n=t.cauStyle()||"";e.button_width=t.cauButtonWidth(),e.button_height=t.cauButtonHeight(),e.button_text_top_padding="2";switch(t.cauStyle()){case"g1":e.button_image_url=JC.f.printf("{0}res/default/g_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:#ffffff; text-align: center; }");break;case"g2":e.button_text_top_padding="4",e.button_height=t.cauButtonHeight(26),e.button_image_url=JC.f.printf("{0}res/default/g_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:#ffffff; text-align: center; }");break;case"g3":e.button_text_top_padding="6",e.button_height=t.cauButtonHeight(28),e.button_image_url=JC.f.printf("{0}res/default/g_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:#ffffff; text-align: center; }");break;case"w1":e.button_text_top_padding="3",e.button_image_url=JC.f.printf("{0}res/default/w_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:##000000; text-align: center; }");break;case"w2":e.button_text_top_padding="4",e.button_height=t.cauButtonHeight(26),e.button_image_url=JC.f.printf("{0}res/default/w_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:#000000; text-align: center; }");break;case"w3":e.button_text_top_padding="6",e.button_height=t.cauButtonHeight(28),e.button_image_url=JC.f.printf("{0}res/default/w_61x27.png",t.cauRoot()),e.button_text_style=t.cauButtonStyle(".uFont{ color:#000000; text-align: center; }");break;default:e.button_text_style=t.cauButtonStyle()}}}),JC.f.extendObject(e.View.prototype,{init:function(){var e=this;$(e).on("UpdateDefaultStatus",function(t){var n=e._model.cauStatusLabel(),r=e._model.cauDisplayLabel();e.updateChange(),e._model.layoutButton().show(),n&&n.length&&n.hide(),r&&r.length&&r.hide(),(e._model.selector().attr("type")||"").toLowerCase()!="hidden"&&e._model.selector().show()}),$(e).on("UploadError",function(n,r,i,s){var o;switch(i){case-110:o=JC.f.printf('<h2>文件大小超出限制</h2>可接受的文件大小: <b style="color:green"><= {0}</b><br />{1}: <b style="color:red">{2}</b>',e._model.cauFileSize(),r.name,t(r.size).replace("i","")),JC.msgbox(o,e._model.layoutButton(),2,null,8e3);break;case-200:o=JC.f.printf('<h2>文件大小超出服务器限制</h2>{1}: <b style="color:red">{2}</b>',e._model.cauFileSize(),r.name,t(r.size).replace("i","")),JC.msgbox(o,e._model.layoutButton(),2,null,8e3);break;case-130:e._model.beforeUploadError(!0),o=JC.f.printf('<h2>文件类型错误</h2>可接受的类型: <b style="color:green">{0}</b><br />本次上传的文件: <b style="color:red">{1}</b>',e._model.cauFileExt(),r.name),JC.msgbox(o,e._model.layoutButton(),2,null,8e3);break;default:alert(["上传出错!","错误代码:",i,"出错原因:",s].join(" "))}e.trigger("UploadComplete")}),$(e).on("CAUUpdate",function(t,n){var r=e._model.cauDisplayLabel(),i="",s="";typeof n!="undefined"&&(s=n.data[e._model.cauValueKey()],i=n.data[e._model.cauLabelKey()],e._model.selector().val(s),e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val(i)),e._model.cauDisplayLabelCallback()?i=e._model.cauDisplayLabelCallback().call(e._model.selector(),n,i,s):i=JC.f.printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',s,i),r&&r.length&&r.html(i)})},beforeUpload:function(){var e=this,t=e._model.cauStatusLabel(),n=e._model.cauProgressBox();this.updateChange(null,!0),t&&t.length&&(e._model.selector().hide(),t.show()),n&&(n.find(".AUPercent").length&&n.find(".AUPercent").attr("width","0"),n.show())},uploadComplete:function(e){var t=this,n=t._model.cauProgressBox();n&&n.length&&n.hide()},uploadProgress:function(e,t,n){var r=this,i=r._model.cauProgressBox(),s,o=0;if(!i||!i.length)return;s=i.find(".AUPercent");if(!s.length)return;t&&(o=t/n*100),s.css("width",o+"%")},updateChange:function(e,t){var n=this,r=n._model.cauStatusLabel(),i=n._model.cauDisplayLabel();r&&r.length&&!t&&(n._model.selector().show(),n._model.layoutButton().show(),r.hide()),i&&i.length&&i.html(""),e&&i&&i.length&&n._model.layoutButton().hide(),n._model.selector().val(""),n._model.cauSaveLabelSelector()&&n._model.cauSaveLabelSelector().val("");if(e&&"errorno"in e&&!e.errorno){$(n).trigger("CAUUpdate",[e]),n._model.selector().val()&&n._model.selector().is(":visible")&&n._model.selector().prop("type").toLowerCase()=="text"&&n._model.selector().trigger("blur");if(i&&i.length){n._model.selector().hide(),i.show();return}}},errUpload:function(e){var t=this,n=t._model.callbackProp("cauBeforeUploadErrCallback"),r=t._model.callbackProp("cauUploadErrCallback");n&&n.call(t._model.selector(),e);if(r)r.call(t._model.selector(),e);else{var i=e&&e.errmsg?e.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(i,1):alert(i)}},errFileExt:function(e){var t=this,n=t._model.callbackProp("cauFileExtErrCallback");if(n)n.call(t._model.selector(),t._model.cauFileExt(),e);else{var r=JC.f.printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',t._model.cauFileExt(),e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFatalError:function(e){var t=this,n=t._model.callbackProp("cauFatalErrorCallback");if(n)n.call(t._model.selector(),e);else{var r=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},disable:function(){var e=this,t=e._model.swfu();t&&(t.setButtonDisabled(!0),JC.log("disable",(new Date).getTime()))},enable:function(){var e=this,t=e._model.swfu();t&&(t.setButtonDisabled(!1),JC.log("enable",(new Date).getTime()))}}),$.event.special.AjaxUploadShowEvent={show:function(e){e.handler&&e.handler()}},$(document).ready(function(){e.autoInit&&setTimeout(function(){e.init()},1)}),JC.AjaxUpload})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);