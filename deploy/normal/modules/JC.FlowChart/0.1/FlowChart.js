(function(define,_win){define(["Raphael","JC.BaseMVC","JC.PopTips"],function(){function FlowChart(e){e&&(e=$(e));if(JC.BaseMVC.getInstance(e,FlowChart))return JC.BaseMVC.getInstance(e,FlowChart);JC.BaseMVC.getInstance(e,FlowChart,this),this._model=new FlowChart.Model(e),this._view=new FlowChart.View(this._model),this._init()}function arrayFirst(e){var t;return e&&e.length&&(t=e[0]),t}function arrayLast(e){var t;return e&&e.length&&(t=e[e.length-1]),t}function distanceAngleToPoint(e,t){var n=t*Math.PI/180;return{x:Math.cos(n)*e,y:Math.sin(n)*e}}var _jdoc=$(document),_jwin=$(window),isIE=!!window.ActiveXObject;return JC.FlowChart=FlowChart,FlowChart.init=function(e){var t=[];return e=$(e||document),e.length&&(e.hasClass("js_compFlowChart")?t.push(new FlowChart(e)):e.find("div.js_compFlowChart").each(function(){t.push(new FlowChart(this))})),t},JC.BaseMVC.build(FlowChart),JC.f.extendObject(FlowChart.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var e=this;e.on("inited",function(){if(!e._model.chartData())return;e._view.draw()})},_inited:function(){this.trigger("inited")}}),FlowChart.Model._instanceName="JCFlowChart",JC.f.extendObject(FlowChart.Model.prototype,{init:function(){},data:function(){return typeof this._data=="undefined"&&this.is("[data-FlowChart]")&&(this._data=eval("("+this.scriptTplProp("data-FlowChart")+")")),this._data},chartData:function(){return this.data().chart},initGrid:function(){var e=this;e._grid={data:[],idColumnIndex:{},idColumnIndexList:[],row:{},idMap:{},columnIndexMap:{},maxColumn:0,rowIndexPad:0,offsetRowIndex:1e4},e.initIdColumnIndex(e.chartData(),e.chartData().id,0,0,0),e.initColumnIndexMap(),e.initRowIndex(),e.fixRowIndex(),e.fixRowIndexOneChild(),e.fixRowIndexMultiChild(),e.createItems(),e.calcRealPosition(),JC.dir(e.gridIdColumnIndexMap())},grid:function(){return this._grid},gridIdColumnIndex:function(){return this.grid().idColumnIndex},gridIdColumnIndexList:function(){return this.grid().idColumnIndexList},gridIdColumnIndexMap:function(){return this.grid().columnIndexMap},gridRow:function(){return this.grid().row},gridIdMap:function(e){return typeof e!="undefined"?this.grid().idMap[e]:this.grid().idMap},gridOffsetRowIndex:function(){return this.grid().offsetRowIndex},gridHeight:function(){return 40},gridWidth:function(){return 120},lineWidth:function(){return 75},childLineWidth:function(){return 40},parentLineWidth:function(){return 25},itemHtmlPattern:function(e){var t="{0}";return"tipsHtml"in e&&e.tipsHtml&&(t=this.tipsTpl()),t},tipsTpl:function(){return this._tipsTpl||(this._tipsTpl=FlowChart.TIPS_TPL,this._tipsTpl=this.scriptTplProp("cfcTipsTpl")||this._tipsTpl),this._tipsTpl},createItems:function(){var e=this,t=0,n=0;e._items={},e._columnWidth=[];for(var r=0;r<=e.gridMaxColumn();r++){var i=e.gridIdColumnIndexMap()[r],s=e.gridWidth();$.each(i,function(t,n){var r=JC.f.printf(e.itemHtmlPattern(n),n.name,n.tipsHtml,e.getStatus(n)),i=JC.f.printf('<div class="js_cfcItem js_cfcItemStatus_{1}" style="position:absolute; left: -1000px;">{0}</div>',r,e.getStatus(n)),o=$(i),u;o.appendTo(e.box()),o.data("nodeData",n),e._items[n.id]=o,u=o.outerWidth(),u>s&&(s=u)}),r===0&&(s=Math.ceil(e._items[e.chartData().id].width()+30)),e._columnWidth.push(s)}},getStatus:function(e){var t=0;return"status"in e&&(t=e.status),t},calcRealPosition:function(){var e=this,t=0,n=0,r=0;e._columnX=[],e._minX=t,e._maxX=0,e._minY=0,e._maxY=0;for(var i=0;i<=e.gridMaxColumn();i++){var s=e.gridIdColumnIndexMap()[i];$.each(s,function(i,s){var o=t,u=n;o+=r,u+=s.rowIndex*e.gridHeight(),u<e._minY&&(e._minY=u),u+e.gridHeight()/2>e._maxY&&(e._maxY=Math.ceil(u+e.gridHeight()/2)),s.x=o,s.y=u}),e._maxX=t+r+e.columnWidth(i),e._columnX.push(t+r),r+=Math.max(e.gridWidth(),e.columnWidth(i))+e.lineWidth(),e.listHasChildline(s)&&(r+=e.childLineWidth()),e.listHasParentline(s)&&(r+=e.parentLineWidth())}},minX:function(){return this._minX},minY:function(){return this._minY},maxX:function(){return this._maxX},maxY:function(){return this._maxY},items:function(){return this._items},item:function(e){return this._items[e]},columnWidth:function(e){return typeof e!=undefined?this._columnWidth[e]||0:this._columnWidth},columnX:function(e){return typeof e!=undefined?this._columnX[e]||0:this._columnX},fixRowIndexOneChild:function(){var e=this,t=0,n=0;for(var r=1;r<e.gridMaxColumn();r++){var i=e.gridIdColumnIndexMap()[r],s=i.length,o;$.each(i,function(t,n){if(n.nodes&&n.nodes&&n.nodes.length===1&&!n.isFixOne){u=n.rowIndex,n.isFixOne=!0;var r=n.nodes,u=n.rowIndex,a=t+1;while(r&&r.length){r[0].rowIndex>u&&(u=r[0].rowIndex),r[0].isFixOne=!0;if(!r[0].nodes||r[0].nodes.length!==1)break;r=r[0].nodes[0]}n.rowIndex=u;while(a<s)i[a].rowIndex=u+(a-t),a++}else n.isFixOne&&n.pid&&n.pid.length===1?n.rowIndex=e.gridIdMap(n.pid[0]).rowIndex:n.pid&&n.pid.length===1&&e.gridIdMap(n.pid[0]).nodes.length===1?n.rowIndex=e.gridIdMap(n.pid[0]).rowIndex:n.targetNode&&(o=e.gridIdMap()[n.targetNode])&&o.pid&&o.pid.length===1&&(o.rowIndex=n.rowIndex,o.isFixOne=!0)})}},fixRowIndexMultiChild:function(){var e=this,t=0,n=0,r,i,s,o;for(var u=1;u<e.gridMaxColumn();u++){var a=e.gridIdColumnIndexMap()[u];$.each(a,function(t,n){n.pid&&n.pid.length>1&&(r=e.gridIdMap()[arrayFirst(n.pid)],i=e.gridIdMap()[arrayLast(n.pid)],s=i.rowIndex-r.rowIndex,o=r.rowIndex+Math.ceil(Math.abs(s)/2),n.rowIndex=o),n.nodes&&n.nodes.length>1&&(r=arrayFirst(n.nodes),i=arrayLast(n.nodes),s=i.rowIndex-r.rowIndex,o=r.rowIndex+Math.ceil(Math.abs(s)/2),n.rowIndex=o)})}},fixRowIndex:function(){var e=this,t=0,n=0,r=0;for(var i=0;i<=e.gridMaxColumn();i++){var s=e.gridIdColumnIndexMap()[i];$.each(s,function(t,n){var i=n.rowIndex-e.gridOffsetRowIndex();n.rowIndex=i,i<r&&(r=i)})}if(r<0){r=Math.abs(r);for(var i=0;i<=e.gridMaxColumn();i++){var s=e.gridIdColumnIndexMap()[i];$.each(s,function(e,t){t.rowIndex+=r})}}},initRowIndex:function(){var e=this;for(var t=0;t<=e.gridMaxColumn();t++){var n=e.gridIdColumnIndexMap()[t],r=e.gridIdColumnIndexMap()[t-1],i=n.length,s=r?r.length:0;r&&(r=r.slice().reverse());if(t===0||t===e.gridMaxColumn()){$.each(n,function(t,n){n.rowIndex=e.gridOffsetRowIndex()});continue}var o=e.gridOffsetRowIndex(),u=e.gridOffsetRowIndex(),a=1,f=e.gridOffsetRowIndex();n.length>1&&(a=n.length*2),f-=Math.floor(a/2),f+=1,$.each(n,function(e,t){t.rowIndex=f+e*2})}},gridMaxColumn:function(e){return typeof e!="undefined"&&(this.grid().maxColumn=e),this.grid().maxColumn},gridRowIndexPad:function(e){return typeof e!="undefined"&&(this.grid().rowIndexPad=e),this.grid().rowIndexPad},initColumnIndexMap:function(){var e=this;$.each(e.gridIdColumnIndexList(),function(t,n){n.columnIndex in e.gridIdColumnIndexMap()?e.gridIdColumnIndexMap()[n.columnIndex].push(n):e.gridIdColumnIndexMap()[n.columnIndex]=[n]})},initIdColumnIndex:function(e,t,n,r,i){var s=this,o=n+1,u=o+1;"columnIndex"in e&&n<e.columnIndex&&(n=e.columnIndex),t in s.gridIdMap()||s.gridIdColumnIndexList().push(e),e.id=t,e.pid=e.pid||[],e.columnIndex=n,s.gridIdColumnIndex()[t]=e,s.gridIdMap()[t]=e,e.zindex=i++,n>s.gridMaxColumn()&&s.gridMaxColumn(n);if(e.nodes&&e.nodes.length){var a={};$.each(e.nodes,function(e,n){n.pid=n.pid||[],n.pid.push(t),"targetNode"in n&&n.targetNode in s.chartData().targetNodes&&(a[n.targetNode]=n.targetNode,s.chartData().targetNodes[n.targetNode].pid=s.chartData().targetNodes[n.targetNode].pid||[],s.chartData().targetNodes[n.targetNode].pid.push(n.id)),s.initIdColumnIndex(n,n.id,o,!1,i)}),$.each(a,function(e,t){s.initIdColumnIndex(s.chartData().targetNodes[e],e,u,!0,i)})}r&&"targetNode"in e&&e.targetNode in s.chartData().targetNodes&&(s.chartData().targetNodes[e.targetNode].pid=s.chartData().targetNodes[e.targetNode].pid||[],s.chartData().targetNodes[e.targetNode].pid.push(t),s.initIdColumnIndex(s.chartData().targetNodes[e.targetNode],e.targetNode,o,!0,i))},buildLayout:function(){var e=this;e._container=$('<div class="js_cfcContainer"></div>'),e._layout=$('<div class="js_cfcLayout"></div>'),e._raphaelPlaceholder=$('<div class="js_cfcRaphael" style="position: absolute;"></div>'),e._box=$('<div class="js_cfcBox" style=""></div>'),e._raphaelPlaceholder.appendTo(e._layout),e._box.appendTo(e._layout),e._layout.appendTo(e._container),e._container.appendTo(e.selector())},layout:function(){return this._layout},box:function(){return this._box},raphaelPlaceholder:function(){return this._raphaelPlaceholder},width:function(){return Math.abs(this._maxX-this._minX)},height:function(){return Math.abs(this._maxY-this._minY+5)},listHasChildline:function(e){var t=!1;return $.each(e,function(e,n){if(n.nodes&&n.nodes.length>1)return t=!0,!1}),t},listHasParentline:function(e){var t=!1,n={};return $.each(e,function(e,r){if(r.targetNode in n)return t=!0,!1;r.targetNode&&!(r.targetNode in n)&&(n[r.targetNode]=1)}),t}}),JC.f.extendObject(FlowChart.View.prototype,{init:function(){},draw:function(){var e=this,t,n;if(!e._model.chartData()||!e._model.chartData().name)return;t=JC.f.ts(),e._model.buildLayout(),e._model.initGrid(),e._model.layout().css({height:Math.abs(e._model.maxY())+"px"}),e.showGrid(),e.showLine(),JC.PopTips.init(e.selector()),n=JC.f.ts(),JC.log("time span:",n-t)},showLine:function(){var e=this,t,n,r=Math.abs(e._model.minY()),i=0;t=n=Raphael(e._model.raphaelPlaceholder()[0],e._model.width(),e._model.height()),!isIE&&(i=1);var s={stroke:"#E1E1E1","stroke-width":2},o={stroke:"#E1E1E1","stroke-width":2,fill:"#F2F2F2"};for(var u=0;u<=e._model.gridMaxColumn();u++){var a=e._model.gridIdColumnIndexMap()[u],f=e._model.listHasChildline(a),l=e._model.listHasParentline(a),c=e._model.columnX(u),h=e._model.columnX(u-1),p=e._model.columnWidth(u),d=e._model.columnWidth(u-1),v=c+p,m,g=e._model.lineWidth(),y=0;l&&(g+=e._model.childLineWidth()),f&&(g+=e._model.parentLineWidth()),$.each(a,function(n,u){var a=e._model.item(u.id),f=u.pid,l=u.nodes,p,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D;if(!f&&!l)return;f&&f.length&&(g=e._model.gridIdMap(arrayFirst(f)),b=e._model.item(g.id),f.length>1?(v=h+d+e._model.parentLineWidth(),y=e._model.gridIdMap(arrayLast(f)),w=e._model.item(y.id),C=u.y+Math.abs(e._model.minY())+a.outerHeight()/2+i,L=g.y+Math.abs(e._model.minY())+b.outerHeight()/2+i,A=y.y+Math.abs(e._model.minY())+w.outerHeight()/2+i,O=u.x-18,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}M{5} {6}L{7} {8}","",v,L,v,A,v,C,O,C)).attr(s),$.each(f,function(n,r){M=e._model.gridIdMap(r),_=e._model.item(M.id),k=M.y+Math.abs(e._model.minY())+_.outerHeight()/2+i,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",M.x,k,v,k)).attr(s)}),t.JCTriangle(16,O,C,o)):g&&f.length===1&&"targetNode"in g&&(v=h+b.outerWidth(),m=g.y+b.outerHeight()/2,u.y=g.y,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",v,m+i,u.x-18,m+i)).attr(s),t.JCTriangle(16,u.x-18,m+i,o))),l&&l.length&&(l.length>1&&(S=u.x+a.outerWidth(),g=arrayFirst(l),y=arrayLast(l),b=e._model.item(g.id),w=e._model.item(y.id),E=g.x,v=E-e._model.childLineWidth(),C=u.y+Math.abs(e._model.minY())+a.outerHeight()/2+i,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",S,C,v-18,C)).attr(s),t.JCTriangle(16,v-18,C,o),L=g.y+Math.abs(e._model.minY())+b.outerHeight()/2+i,A=y.y+Math.abs(e._model.minY())+w.outerHeight()/2+i,O=u.x-18,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",v,L,v,A)).attr(s),$.each(l,function(n,r){M=r,_=e._model.item(M.id),k=M.y+Math.abs(e._model.minY())+_.outerHeight()/2+i,t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",v,k,M.x,k)).attr(s)})),l.length===1&&(v=c+a.outerWidth(),m=u.y+a.outerHeight()/2,p=l[0],t.path(JC.f.printf("{0}M{1} {2}L{3} {4}","",v,m+r+i,p.x-18,m+r+i)).attr(s),t.JCTriangle(16,p.x-18,m+r+i,o)))})}},showGrid:function(){var e=this;for(var t=0;t<=e._model.gridMaxColumn();t++){var n=e._model.gridIdColumnIndexMap()[t];$.each(n,function(t,n){var r=e._model.item(n.id);r.css({left:n.x+"px",top:n.y+"px"})})}}}),FlowChart.TIPS_TPL=['<span class="js_compPopTips" style="display:inline-block;"','htmlContent="|script"','theme="white"','arrowposition="bottom"','triggerType="hover"','offsetXY="0,-4"','popTipsMinWidth="100"','popTipsMinHeight="50"',">","<span>{0}</span>",'<script type="text/template"><div class="js_cfcItemTips js_cfcItemTips_{2}">{1}</div></script>',"</span>"].join(""),Raphael.fn.JCTriangle=function(e,t,n,r,i){!e&&(e=16),!t&&(t=0),!n&&(n=e/2),n+=1,typeof i=="undefined"&&(i=180);var s=distanceAngleToPoint(e,330),o=distanceAngleToPoint(e,30),u=distanceAngleToPoint(e,120);s.x=parseInt(s.x+t),s.y=parseInt(s.y+n),o.x=parseInt(o.x+t),o.y=parseInt(o.y+n);var a=this.path(JC.f.printf("{0}M{1} {2}L{3} {4}L{5} {6}L{1} {2}Z","",t,n,s.x,s.y,o.x,o.y));return a.rotate(i),r&&a.attr(r),a},_jdoc.ready(function(){FlowChart.autoInit&&FlowChart.init()}),JC.FlowChart})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);