(function(b,a){b(["JC.common"],function(){window.Suggest=JC.Suggest=c;function c(f){f&&(f=$(f));if(c.getInstance(f)){return c.getInstance(f)}c.getInstance(f,this);c._allIns.push(this);this._model=new e(f);this._view=new d(this._model);this._init()}c.prototype={_init:function(){var f=this;$([f._view,f._model]).on("BindEvent",function(g,i,h){f.on(i,h)});$([f._view,f._model]).on("TriggerEvent",function(g,i,h){f.trigger(i,[h])});f._view.init();f._model.init();f.selector().attr("autocomplete","off");f._initActionEvent();f.trigger("SuggestInited");return f},update:function(g,h){var f=this;typeof h=="undefined"&&(h=g);if(f._model.sugdatafilter()){h=f._model.sugdatafilter().call(this,h)}if(h&&h.q){f._model.cache(h.q,h)}this._view.update(h)},show:function(){this._view.show();return this},hide:function(){this._view.hide();return this},selector:function(){return this._model.selector()},layout:function(){return this._model.layout()},on:function(g,f){$(this).on(g,f);return this},trigger:function(g,f){$(this).trigger(g,f);return this},_initActionEvent:function(){var f=this;f.on("SuggestUpdate",f.update);f.on("SuggestInited",function(g){if(f._model.suginitedcallback()){f._model.suginitedcallback().call(f)}});f._model.selector().on("keyup",function(i){var g=$(this),k=g.val().trim(),j=i.keyCode,h=g.data("IgnoreTime");if(h&&(new Date().getTime()-h)<300){return}JC.log("keyup",k,new Date().getTime(),j);if(j){switch(j){case 38:case 40:i.preventDefault();case 37:case 39:return;case 27:f.hide();return}}if(!k){f.update();return}if(!f._model.layout().is(":visible")){if(f._model.cache(k)){f.update(f._model.cache(k));return}}if(f._model.preValue===k){return}f._model.preValue=k;if(f._model.cache(k)){f.update(f._model.cache(k));return}JC.log(k);if(f._model.sugqueryinterval()){if(f._model.timeout){clearTimeout(f._model.timeout)}f._model.timeout=setTimeout(function(){f._model.getData(k)},f._model.sugqueryinterval())}else{f._model.getData(k)}});f._model.selector().on("blur",function(g){f._model.timeout&&clearTimeout(f._model.timeout)});f._model.selector().on("keydown",function(h){var l=h.keyCode,g=$(this),m,j,k=f._model.items(),i;l==38&&(j=true);JC.log("keyup",new Date().getTime(),l);switch(l){case 38:case 40:m=f._model.nextIndex(j);if(m>=0&&m<k.length){h.preventDefault();i=$(k[m]);f._model.selectedIdentifier(i);f.selector().val(f._model.getKeyword(i));return}break;case 9:f.hide();return;case 13:f.hide();g.data("IgnoreTime",new Date().getTime());f._model.sugprevententer()&&h.preventDefault();break}});$(f._model.layout()).delegate(".js_sugItem","mouseenter",function(g){f._model.selectedIdentifier($(this),true)});$(f._model.layout()).delegate(".js_sugItem","mouseleave",function(g){$(this).removeClass("active")});f.selector().on("click",function(g){g.stopPropagation();f.selector().trigger("keyup");c._hideOther(f)});$(f._model.layout()).delegate(".js_sugItem","click",function(h){var g=$(this),i=f._model.getKeyword(g);f.selector().val(i);f.hide();f.trigger("SuggestSelected",[g]);f._model.sugselectedcallback()&&f._model.sugselectedcallback().call(f,i);setTimeout(function(){f.selector().trigger("blur")},50)});if(f._model.sugautoposition()){$(window).on("resize",function(){if(f._model.layout().is(":visible")){f._view.show()}})}}};c.getInstance=function(f,g){if(typeof f=="string"&&!/</.test(f)){f=$(f)}if(!(f&&f.length)||(typeof f=="string")){return}typeof g!="undefined"&&f.data("SuggestInstace",g);return f.data("SuggestInstace")};c.isSuggest=function(f){var g;f&&(f=$(f)).length&&(g=f.is("[sugurl]")||f.is("sugstaticdatacb"));return g};c.autoInit=true;c.layoutTpl="";c.layoutTpl="";c.dataFilter;c._allIns=[];c._hideOther=function(h){for(var g=0,f=c._allIns.length;g<f;g++){if(c._allIns[g]._model._id!=h._model._id){c._allIns[g].hide()}}};function e(f){this._selector=f;this._id="Suggest_"+new Date().getTime()}e.prototype={init:function(){return this},selector:function(){return this._selector},suglayouttpl:function(){var f=this,h=c.layoutTpl||f.layoutTpl,g;(g=f.selector().attr("suglayouttpl"))&&(h=g);return h},layoutTpl:'<dl class="sug_layout js_sugLayout" style="display:none;"></dl>',layout:function(){var f=this;!f._layout&&f.selector().is("[suglayout]")&&(f._layout=JC.f.parentSelector(f.selector(),f.selector().attr("suglayout")));!f._layout&&(f._layout=$(f.suglayouttpl()),f._layout.hide(),f._layout.appendTo(document.body),(f._sugautoposition=true));!f._layout.hasClass("js_sugLayout")&&f._layout.addClass("js_sugLayout");if(f.sugwidth()){f._layout.css({width:f.sugwidth()+"px"})}f._layout.css({width:f._layout.width()+f.sugoffsetwidth()+"px"});return f._layout},sugautoposition:function(){this.layout().is("sugautoposition")&&(this._sugautoposition=JC.f.parseBool(this.layout().attr("sugautoposition")));return this._sugautoposition},sugwidth:function(){this.selector().is("[sugwidth]")&&(this._sugwidth=parseInt(this.selector().attr("sugwidth")));!this._sugwidth&&(this._sugwidth=this.sugplaceholder().width());return this._sugwidth},sugoffsetleft:function(){this.selector().is("[sugoffsetleft]")&&(this._sugoffsetleft=parseInt(this.selector().attr("sugoffsetleft")));!this._sugoffsetleft&&(this._sugoffsetleft=0);return this._sugoffsetleft},sugoffsettop:function(){this.selector().is("[sugoffsettop]")&&(this._sugoffsettop=parseInt(this.selector().attr("sugoffsettop")));!this._sugoffsettop&&(this._sugoffsettop=0);return this._sugoffsettop},sugoffsetwidth:function(){this.selector().is("[sugoffsetwidth]")&&(this._sugoffsetwidth=parseInt(this.selector().attr("sugoffsetwidth")));!this._sugoffsetwidth&&(this._sugoffsetwidth=0);return this._sugoffsetwidth},_dataCallback:function(f){$(this).trigger("TriggerEvent",["SuggestUpdate",f])},sugdatacallback:function(){var f=this;this.selector().is("[sugdatacallback]")&&(this._sugdatacallback=this.selector().attr("sugdatacallback"));!this._sugdatacallback&&(this._sugdatacallback=f._id+"_cb");!window[this._sugdatacallback]&&(window[this._sugdatacallback]=function(g){f._dataCallback(g)});return this._sugdatacallback},sugurl:function(f){this.selector().is("[sugurl]")&&(this._sugurl=this.selector().attr("sugurl"));!this.selector().is("[sugurl]")&&(this._sugurl="?word={0}&callback={1}");this._sugurl=JC.f.printf(this._sugurl,f,this.sugdatacallback());return this._sugurl},sugneedscripttag:function(){this._sugneedscripttag=true;this.selector().is("[sugneedscripttag]")&&(this._sugneedscripttag=JC.f.parseBool(this.selector().attr("sugneedscripttag")));return this._sugneedscripttag},getData:function(j){var g=this,h=this.sugurl(j),i,f="script_"+g._id;JC.log(h,new Date().getTime());if(this.sugneedscripttag()){$("#"+f).remove();i=JC.f.printf('<script id="{1}" src="{0}"><\/script>',h,f);$(i).appendTo(document.body)}else{$.get(h,function(k){k=$.parseJSON(k);g._dataCallback(k)})}},cache:function(f,g){this._cache=this._cache||{};typeof g!="undefined"&&(this._cache[f]=g);return this._cache[f]},sugselectedcallback:function(){var f=this;this.selector().is("[sugselectedcallback]")&&(this._sugselectedcallback=this.selector().attr("sugselectedcallback"));return this._sugselectedcallback?window[this._sugselectedcallback]:null},suginitedcallback:function(){var f=this;this.selector().is("[suginitedcallback]")&&(this._suginitedcallback=this.selector().attr("suginitedcallback"));return this._suginitedcallback?window[this._suginitedcallback]:null},sugdatafilter:function(){var f=this;this.selector().is("[sugdatafilter]")&&(this._sugdatafilter=this.selector().attr("sugdatafilter"));this._sugdatafilter=this._sugdatafilter||c.dataFilter;return this._sugdatafilter?window[this._dataCallback]:null},sugqueryinterval:function(){this.selector().is("[sugqueryinterval]")&&(this._sugqueryinterval=parseInt(this.selector().attr("sugqueryinterval")));this._sugqueryinterval=this._sugqueryinterval||200;return this._sugqueryinterval},sugprevententer:function(){var f;this.selector().is("[sugprevententer]")&&(f=JC.f.parseBool(this.selector().attr("sugprevententer")));return f},timeout:null,preValue:null,keyindex:-1,nextIndex:function(g){var h=this.items(),f=h.length;if(g){if(this.keyindex<=0){this.keyindex=f-1}else{this.keyindex--}}else{if(this.keyindex>=f-1){this.keyindex=0}else{this.keyindex++}}return this.keyindex},items:function(){return this.layout().find(".js_sugItem")},selectedIdentifier:function(g,f){this._preSelected&&this._preSelected.removeClass("active");g.addClass("active");f&&(this.keyindex=parseInt(g.attr("keyindex")));this._preSelected=g},getKeyword:function(f){var h=f.attr("keyword");try{h=decodeURIComponent(h)}catch(g){}return h},currentData:function(f){typeof f!="undefined"&&(this._currentData=f);return this._currentData},sugsubtagname:function(){var g="dd",f;(f=this.selector().attr("sugsubtagname"))&&(g=f);return g},sugplaceholder:function(){var f=this.selector();this.selector().is("[sugplaceholder]")&&(f=JC.f.parentSelector(this.selector(),this.selector().attr("sugplaceholder")));return f}};function d(f){this._model=f}d.prototype={init:function(){return this},show:function(){var f=this;$(this).trigger("TriggerEvent",["SuggestBeforeShow"]);this._model.layout().css("z-index",window.ZINDEX_COUNT++);this.autoposition();this._model.layout().show();setTimeout(function(){f._model.layout().show()},10);$(this).trigger("TriggerEvent",["SuggestShow"])},autoposition:function(){if(!this._model.sugautoposition()){return}var f=this,g=f._model.sugplaceholder().offset(),h=f._model.sugplaceholder().height();f._model.layout().css({left:g.left+f._model.sugoffsetleft()+"px",top:g.top+f._model.sugoffsettop()+h+"px"})},hide:function(){this._model.layout().hide();this.reset();$(this).trigger("TriggerEvent",["SuggestHide"])},update:function(h){var g=this,f=[],p,o,n,k=g._model.sugsubtagname();if(!(h&&h.s&&h.s.length)){g.hide();return}for(var m=0,l=h.s.length;m<l;m++){o=h.s[m],n=o,p=h.q||"";n=n.replace(p,JC.f.printf("<b>{0}</b>",p));f.push(JC.f.printf('<{4} keyword="{2}" keyindex="{3}" class="js_sugItem">{1}</{4}>',p,n,encodeURIComponent(o),m,k))}g._model.layout().html(f.join(""));JC.log("suggest update");this.reset();g._model.currentData(h);$(this).trigger("TriggerEvent",["SuggestUpdated"]);g.show()},reset:function(){JC.log("suggest reset");this._model.keyindex=-1;this._model.layout().find(".js_sugItem").removeClass("active");$(this).trigger("TriggerEvent",["SuggestReset"])}};$(document).delegate("input[type=text]","focus",function(g){var f=$(this),h=c.getInstance(f);if(f.is("[readonly]")||f.is("[disabled]")){return}if(h||!c.isSuggest(f)||!c.autoInit){return}JC.log("Suggest input fined:",f.attr("name"),new Date().getTime());h=new c(f)});$(document).on("click",function(f){$("dl.js_sugLayout, div.js_sugLayout").hide()});return JC.Suggest})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));