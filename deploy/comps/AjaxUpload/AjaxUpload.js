(function(b,a){b(["JC.BaseMVC","JC.Panel"],function(){(function(c){window.JC=window.JC||{log:function(){}};JC.AjaxUpload=d;function d(e){if(d.getInstance(e)){return d.getInstance(e)}if(!e.hasClass("js_compAjaxUpload")){return d.init(e)}d.getInstance(e,this);this._model=new d.Model(e);this._view=new d.View(this._model);JC.log("AjaxUpload init",new Date().getTime());this._init()}d.getInstance=function(e,f){if(typeof e=="string"&&!/</.test(e)){e=c(e)}if(!(e&&e.length)||(typeof e=="string")){return}typeof f!="undefined"&&e.data(d.Model._instanceName,f);return e.data(d.Model._instanceName)};d.init=function(e){var f=[];e=c(e||document);if(e.hasClass("js_compAjaxUpload")){f.push(new d(e))}else{e.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){f.push(new d(c(this)))})}return f};d.frameFileName="default.html";d.randomFrame=false;d._FRAME_DIR="modules/JC.AjaxUpload/0.1/frame/";b&&!b.amd&&(d._FRAME_DIR="comps/AjaxUpload/frame/");d._INS_COUNT=1;d.prototype={_beforeInit:function(){var e=this;JC.log("AjaxUpload _beforeInit",new Date().getTime())},_initHanlderEvent:function(){var e=this;e.on("FrameLoad",function(f){var g=e._model.frame().prop("contentWindow");if(!(g&&g.initPage)){return}g.initPage(e,e._model);if(e._model.INITED){return}e._model.INITED=true;if(e._model.cauDefaultHide()){setTimeout(function(){e._model.frame().hide();e._model.selector().hide()},1)}e._model.selector().on("show",function(h){JC.log("show")});e._model.selector().on("hide",function(h){JC.log("hide")});e._model.frame().on("show",function(h){JC.log("show")});e._model.frame().on("hide",function(h){JC.log("hide")})});e.on("ERR_FILE_EXT",function(f,g){e._view.errFileExt(g);e._view.updateChange()});e.on("BeforeUpload",function(f){e._view.beforeUpload()});e.on("UploadDone",function(g,f){JC.log(f);var j=false,i=f;try{typeof f=="string"&&(f=c.parseJSON(f))}catch(h){f={};j=true}if(j){e._view.errFatalError(i);e._view.updateChange();e._model.cauUploadErrorCallback()&&e._model.cauUploadErrorCallback().call(e,f,e._model.selector(),e._model.frame())}else{if(f.errorno){e._view.errUpload(f);e._view.updateChange()}else{e._view.updateChange(f)}e._model.cauUploadDoneCallback()&&e._model.cauUploadDoneCallback().call(e,f,e._model.selector(),e._model.frame())}});e.on("AUUpdateLayout",function(g,f,h,i){e._view.updateLayout(f,h,i)})},_inited:function(){var e=this;JC.log("AjaxUpload _inited",new Date().getTime());e._view.loadFrame();d.getInstance(e._model.frame(),e);e.trigger("AUInited")},update:function(f){var e=this;c(e._view).trigger("UpdateDefaultStatus");f&&e.trigger("UploadDone",[f]);return this}};BaseMVC.buildModel(d);d.Model._instanceName="AjaxUpload";d.Model.prototype={init:function(){JC.log("AjaxUpload.Model.init:",new Date().getTime())},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileName:function(){return this.attrProp("cauFileName")||this.attrProp("name")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauSaveLabelSelector:function(){var e=this.selectorProp("cauSaveLabelSelector");return e},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauHideButton:function(){var e=false;this.is("[cauHideButton]")&&(e=this.boolProp(this.attrProp("cauHideButton")));return e},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},framePath:function(){var e=this.attrProp("cauFrameFileName")||d.frameFileName,f=JC.f.printf("{0}{1}{2}",JC.PATH,d._FRAME_DIR,e);this.randomFrame()&&(f=JC.f.addUrlParams(f,{rnd:new Date().getTime()}));return f},randomFrame:function(){var e=d.randomFrame;this.selector().is("[cauRandomFrame]")&&(e=this.boolProp("cauRandomFrame"));return e},frame:function(){if(!this._iframe){var e=d.frameTpl;if(this.selector().is("[cauFrameScriptTpl]")){e=JC.f.scriptContent(JC.f.parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))}this._iframe=c(d.frameTpl)}return this._iframe}};BaseMVC.buildView(d);d.View.prototype={init:function(){JC.log("AjaxUpload.View.init:",new Date().getTime());var e=this;c(e).on("UpdateDefaultStatus",function(g){var h=e._model.cauStatusLabel(),f=e._model.cauDisplayLabel();e.updateChange();e._model.frame().show();h&&h.length&&h.hide();f&&f.length&&f.hide();(e._model.selector().attr("type")||"").toLowerCase()!="hidden"&&e._model.selector().show()});c(e).on("CAUUpdate",function(i,g){var f=e._model.cauDisplayLabel(),j="",h="";if(typeof g!="undefined"){h=g.data[e._model.cauValueKey()];j=g.data[e._model.cauLabelKey()];e._model.selector().val(h);e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val(j)}if(e._model.cauDisplayLabelCallback()){j=e._model.cauDisplayLabelCallback().call(e._model.selector(),g,j,h)}else{j=JC.f.printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',h,j)}f&&f.length&&f.html(j)})},loadFrame:function(){var e=this,g=e._model.framePath(),f=e._model.frame();JC.log(g);f.attr("src",g);f.on("load",function(){c(e).trigger("TriggerEvent","FrameLoad")});e._model.selector().before(f)},beforeUpload:function(){var e=this,f=e._model.cauStatusLabel();JC.log("AjaxUpload view#beforeUpload",new Date().getTime());this.updateChange(null,true);if(f&&f.length){e._model.selector().hide();e._model.frame().hide();f.show()}},updateChange:function(g,h){var e=this,i=e._model.cauStatusLabel(),f=e._model.cauDisplayLabel();if(i&&i.length&&!h){e._model.selector().show();e._model.frame().show();i.hide()}if(f&&f.length){f.html("")}e._model.selector().val("");e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val("");if(g&&("errorno" in g)&&!g.errorno){c(e).trigger("CAUUpdate",[g]);e._model.selector().val()&&e._model.selector().is(":visible")&&e._model.selector().prop("type").toLowerCase()=="text"&&e._model.selector().trigger("blur");if(f&&f.length){e._model.selector().hide();if(e._model.is("[cauHideButton]")){e._model.cauHideButton()&&e._model.frame().hide()}else{e._model.frame().hide()}f.show();return}}},updateLayout:function(f,g,h){if(!(f&&g)){return}var e=this;JC.log("AjaxUpload @event UpdateLayout",new Date().getTime(),f,g);e._model.frame().css({width:f+"px",height:g+"px"})},errUpload:function(f){var e=this,g=e._model.callbackProp("cauUploadErrCallback");if(g){g.call(e._model.selector(),f,e._model.frame())}else{var h=f&&f.errmsg?f.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(h,1):alert(h)}},errFileExt:function(g){var e=this,f=e._model.callbackProp("cauFileExtErrCallback");if(f){f.call(e._model.selector(),e._model.cauFileExt(),g,e._model.frame())}else{var h=JC.f.printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',e._model.cauFileExt(),g);JC.Dialog?JC.Dialog.alert(h,1):alert(h)}},errFatalError:function(f){var e=this,g=e._model.callbackProp("cauFatalErrorCallback");if(g){g.call(e._model.selector(),f,e._model.frame())}else{var h=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',f);JC.Dialog?JC.Dialog.alert(h,1):alert(h)}}};BaseMVC.build(d);c.event.special.AjaxUploadShowEvent={show:function(e){if(e.handler){e.handler()}}};d.frameTpl=JC.f.printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;");c(document).ready(function(){d.autoInit&&d.init()})}(jQuery));return JC.AjaxUpload})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));