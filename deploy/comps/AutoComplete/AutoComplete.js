(function(b,a){b(["JC.BaseMVC"],function(){(function(d){JC.AutoComplete=c;function c(e){e&&(e=d(e));if(c.getInstance(e)){return c.getInstance(e)}c.getInstance(e,this);this._model=new c.Model(e);this._view=new c.View(this._model);this._init();JC.log("AutoComplete inited",new Date().getTime())}c.getInstance=function(e,f){if(typeof e=="string"&&!/</.test(e)){e=d(e)}if(!(e&&e.length)||(typeof e=="string")){return}typeof f!="undefined"&&e.data(c.Model._instanceName,f);return e.data(c.Model._instanceName)};c.init=function(e){var f=[];e=d(e||document);if(e&&e.length){if(e.hasClass("js_compAutoComplete")){f.push(new c(e))}else{e.find("input.js_compAutoComplete").each(function(){f.push(new c(this))})}}return f};c.update=function(e,g){var f=c.getInstance(e);!f&&(f=new c(e));f&&f.update(g);return f};c.ajaxUpdate=function(e,g,h){var f=c.getInstance(e);!f&&(f=new c(e));f&&f.ajaxUpdate(g,h);return f};c.dataFilter;c.fixHtmlEntity=true;BaseMVC.build(c);JC.f.extendObject(c.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var e=this;e._model.selector().on("click",function(g){g.stopPropagation()});e._model.selector().on("focus",function(){e._view.updateList();e.trigger(c.Model.SHOW);e.selector().addClass(c.Model.CLASS_FAKE)});e._model.selector().on("blur",function(){e._model.preVal=e._model.selector().val().trim();e.selector().removeClass(c.Model.CLASS_FAKE);e._model.verifyKey()});e._model.selector().on("keyup",function(h){var i=h.keyCode,g=d(this),j=g.val().trim();if(i==38||i==40){c.Model.isScroll=true}JC.log("keyup",i,new Date().getTime());if(i){switch(i){case 38:case 40:h.preventDefault();case 37:case 39:return;case 27:e.trigger(c.Model.HIDDEN);return}}});e._model.selector().on("keydown",function(g){var h=g.keyCode,i=e._model.selector().val().trim();if(h==38||h==40){c.Model.isScroll=true}JC.log("keydown",new Date().getTime());if(h){switch(h){case 40:case 38:case 13:if(!e._model.popup().is(":visible")){return}break}if(!e._model.popup().is(":visible")){e.trigger(c.Model.SHOW)}switch(h){case 40:case 38:e.trigger(c.Model.UPDATE_LIST_INDEX,[h,g]);return;case 37:case 39:return;case 13:e.trigger(c.Model.ENTER,[g]);return;case 9:case 27:e.trigger(c.Model.HIDDEN);return}}e._model.keydownTimeout(setTimeout(function(){e.trigger(c.Model.UPDATE_LIST)},200))});e._model.popup().on("click",function(g){g.stopPropagation()});e._model.popup().delegate("li","click",function(g){if(!d(this).is("["+e._model.cacLabelKey()+"]")){return}e.trigger(c.Model.CHANGE,[d(this)]);e.trigger(c.Model.HIDDEN);e._model.blurTimeout(setTimeout(function(){e._model.selector().trigger("blur")},50))});e.on(c.Model.HIDDEN,function(){e._view.hide()});e.on(c.Model.SHOW,function(){e._view.show()});e._model.popup().delegate("> li","mouseenter",function f(g){if(c.Model.isScroll){return}e._view.updateIndex(d(this).attr("data-index"),true)});e.on(c.Model.ENTER,function(h,g){e._model.cacPreventEnter()&&g.preventDefault();var i=e._model.selectedItem();i&&i.length&&e.trigger(c.Model.CHANGE,[i]);e.trigger(c.Model.HIDDEN)});e.on(c.Model.UPDATE_LIST_INDEX,function(h,i,g){g.preventDefault();JC.log(c.Model.UPDATE_LIST_INDEX,i,new Date().getTime());e._view.updateListIndex(i==40?true:false);var j=e._model.selectedItem();j&&j.length&&e.trigger(c.Model.CHANGE,[j])});e.on(c.Model.UPDATE_LIST,function(g){this._view.updateList(this._model.selector())});e.on(c.Model.CHANGE,function(g,h){e._model.setSelectorData(h)});e.on(c.Model.UPDATE,function(h,g,i){e._model.initPopupData(g);e._view.build(g);i&&i.call(e,g)});e.on(c.Model.CLEAR,function(g){e._model.selector().val("");e._model.setIdSelectorData()});e._model.selector().on(c.Model.REMOVE,function(){try{e._model.popup().remove()}catch(g){}})},_inited:function(){var e=this;e._model.initData=e._model.dataItems();e.ajaxUpdate();if(!e._model.selector().is("[validCheckTimeout]")){e._model.selector().attr("validCheckTimeout",e._model.cacValidCheckTimeout())}},idSelector:function(){return this._model.cacIdSelector()},idVal:function(){return this._model.cacIdVal()},ajaxUpdate:function(e,f){this._model.ajaxData(e,f);return this},show:function(){var e=this;setTimeout(function(){e.trigger(c.Model.SHOW)},1);return e},hide:function(){this.trigger(c.Model.HIDDEN);return this},popup:function(){return this._model.popup()},update:function(f){var e=this;!e._model.firstUpdate&&e.clear();e._model.firstUpdate=false;f=e._model.cacDataFilter(f);e.trigger(c.Model.UPDATE,[f]);e.trigger(c.Model.UPDATE_LIST);return e},clear:function(){this.trigger(c.Model.CLEAR);return this},fixPosition:function(){var e=this._model.popup();e&&e.length&&e.is(":visible")&&this._view.show();return this}});c.Model._instanceName="AutoComplete";c.Model.UPDATE="AC_UPDATE";c.Model.CLEAR="AC_CLEAR";c.Model.ENTER="AC_ENTER";c.Model.CHANGE="AC_CHANGE";c.Model.HIDDEN="AC_HIDDEN";c.Model.SHOW="AC_SHOW";c.Model.UPDATE_LIST="AC_UPDATE_LIST";c.Model.UPDATE_LIST_INDEX="AC_UPDATE_LIST_INDEX";c.Model.REMOVE="AC_AUTOCOMPLETE_REMOVE";c.Model.CLASS_ACTIVE="AC_active";c.Model.CLASS_FAKE="AC_fakebox";c.Model.AJAX_CACHE={};JC.f.extendObject(c.Model.prototype,{init:function(){this.initData;this._cache={};this.firstUpdate=true},listItemTpl:function(){var e=JC.f.printf("<li "+this.cacIdKey()+'="{0}" '+this.cacLabelKey()+'="{1}" data-index="{2}" class="AC_listItem {3}">{1}</li>');return e},popup:function(){var e=this,f=e.selector().data("AC_panel");!f&&(f=this.selectorProp("cacPopup"));if(!(f&&f.length)){f=d(JC.f.printf('<ul class="AC_box js_compAutoCompleteBox"{0}>{1}</ul>',' style="display:none;position:absolute;"','<li style="text-align:center;">'+e.cacNoDataText()+"</li>"));e.selector().data("AC_panel",f);f.appendTo(document.body)}if(!this._inited){this._inited=true;f.css({width:e.cacBoxWidth()+"px"})}return f},initPopupData:function(e){this.initData=e},verifyKey:function(){if(!this.cacStrictData()){return}var f=this,l=this.selector().val().trim(),j=[],e=f.selector().is("[cacIdKey]"),k;if(!l){f.selector().val("");f.setIdSelectorData();return}if(l){var i=f.cacIdVal(),h,g;d.each(f.initData,function(o,n){if(e){var m=n.label.trim();if(m===l){k=true;!g&&f.setIdSelectorData(n.id);g=true}if(m===l&&!i){f.setIdSelectorData(i=n.id)}if(m===l&&n.id===i){j.push(n);!h&&(f.setIdSelectorData(n.id));h=true;k=true;return false}}else{if(n.label.trim()==l){j.push(n);k=true}}})}if(!k){f.selector().val("");f.setIdSelectorData()}},cache:function(e){JC.log("................cache",e);if(!(e in this._cache)){this._cache[e]=this.keyData(e)||this.initData}return this._cache[e]},dataItems:function(){var e=this,g=e.listItems(),f=[];g.each(function(j,i){var h=d(this);f.push({id:h.attr(e.cacIdKey())||"",label:h.attr(e.cacLabelKey())})});return f},ajaxData:function(f,g){var e=this,f=f||e.attrProp("cacAjaxDataUrl");if(!f){return}if(f in c.Model.AJAX_CACHE){d(e).trigger("TriggerEvent",[c.Model.UPDATE,c.Model.AJAX_CACHE[f],g]);return}d.get(f).done(function(h){h=d.parseJSON(h);h=e.cacDataFilter(h);c.Model.AJAX_CACHE[f]=h;d(e).trigger("TriggerEvent",[c.Model.UPDATE,c.Model.AJAX_CACHE[f],g])})},keyData:function(e){var g=this,f=g.initData,k=0,j=g.cacCasesensitive(),m=e.toLowerCase(),i=[[],[],[],[]],h=[];for(k=0;k<f.length;k++){var l=f[k].label.toLowerCase();if(f[k].label.indexOf(e)==0){i[f[k].tag=0].push(f[k])}else{if(!j&&l.indexOf(m)==0){i[f[k].tag=1].push(f[k])}else{if(f[k].label.indexOf(e)>0){i[f[k].tag=2].push(f[k])}else{if(!j&&l.indexOf(m)>0){i[f[k].tag=3].push(f[k])}}}}}d.each(i,function(o,n){h=h.concat(n)});return h},setSelectorData:function(f){f&&(f=d(f));if(!(f&&f.length)){return}var e=this,h=f.attr(e.cacLabelKey()).trim(),g=f.attr(e.cacIdKey()).trim();e.selector().val(h);e.selector().attr("cacIdVal",g);e.setIdSelectorData(g)},setIdSelectorData:function(f){var e=this;if(!(e.cacIdSelector()&&e.cacIdSelector().length)){return}if(typeof f!="undefined"){e.cacIdSelector().val(f);e.selector().attr("cacIdVal",f)}else{e.cacIdSelector().val("");e.selector().attr("cacIdVal","")}},listItems:function(){var e;this.popup()&&this.popup().length&&(e=this.popup().find(this.cacSubItemsSelector()));return e},selectedItem:function(){var e;this.listItems().each(function(){var f=d(this);if(f.hasClass(c.Model.CLASS_ACTIVE)){e=f;return false}});return e},keyupTimeout:function(e){this._keyupTimeout&&clearTimeout(this._keyupTimeout);this._keyupTimeout=e},keydownTimeout:function(e){this._keydownTimeout&&clearTimeout(this._keydownTimeout);this._keydownTimeout=e},blurTimeout:function(e){this._blurTimeout&&clearTimeout(this._blurTimeout);this._blurTimeout=e},cacDataFilter:function(f){var e=this,g=e.callbackProp("cacDataFilter")||c.dataFilter;g&&(f=g(f));if(e.cacFixHtmlEntity()){d.each(f,function(i,h){h.label&&(h.label=d("<p>"+h.label+"</p>").text())})}return f},cacNoDataText:function(){var e=this.attrProp("cacNoDataText")||"数据加载中, 请稍候...";return e},cacValidCheckTimeout:function(){var e=this.intProp("cacValidCheckTimeout")||c.validCheckTimeout||1;return e},cacStrictData:function(){var e=this.boolProp("cacStrictData");return e},cacFixHtmlEntity:function(){var e=c.fixHtmlEntity;this.selector().is("[cacFixHtmlEntity]")&&(e=this.boolProp("cacFixHtmlEntity"));return e},cacLabelKey:function(){var e=this.attrProp("cacLabelKey")||"data-label";return e},cacIdKey:function(e){typeof e!="undefined"&&(this.selector().attr("cacIdKey",e));var f=this.attrProp("cacIdKey")||this.cacLabelKey();return f},cacIdVal:function(){var e=this,f=e.attrProp("cacIdVal");e.cacIdSelector()&&e.cacIdSelector().length&&(f=e.cacIdSelector().val());f=(f||"").trim();return f},cacIdSelector:function(){var e=this.selectorProp("cacIdSelector");return e},cacPreventEnter:function(){var e;e=this.selector().is("[cacPreventEnter]")&&JC.f.parseBool(this.selector().attr("cacPreventEnter"));return e},cacBoxWidth:function(){var e=0||this.intProp("cacBoxWidth");!e&&(e=this.selector().width());return e},cacCasesensitive:function(){return this.boolProp("cacCasesensitive")},cacSubItemsSelector:function(){var e=this.attrProp("cacSubItemsSelector")||"> li";e+="["+this.cacLabelKey()+"]";return e}});JC.f.extendObject(c.View.prototype,{init:function(){var e=this;e._model.listItems().each(function(f){d(this).attr("data-index",f)}).removeClass(c.Model.CLASS_ACTIVE).first().addClass(c.Model.CLASS_ACTIVE)},hide:function(){var e=this;e._model.popup().hide()},show:function(){var e=this,f=e._model.selector().offset(),k=e._model.selector().prop("offsetHeight"),h=e._model.selector().prop("offsetWidth");e._model.popup().css({top:f.top+k+"px",left:f.left+"px"});var j,l=e._model.selector().val().trim(),g=e._model.cacIdVal(),i=e._model.cacLabelKey()!=e._model.cacIdKey();e._model.listItems().each(function(){var m=d(this),o=m.attr(e._model.cacLabelKey()),n=m.attr(e._model.cacIdKey());m.removeClass(c.Model.CLASS_ACTIVE);if(l==o){if(i&&g){g==n&&m.addClass(c.Model.CLASS_ACTIVE);j=m}else{m.addClass(c.Model.CLASS_ACTIVE);j=m}}});if(!j){e._model.listItems().first().addClass(c.Model.CLASS_ACTIVE)}e._model.popup().show()},updateList:function(){var e=this,h,j=[],i=e._model.selector().val().trim(),f=e._model.cacIdVal(),g;if(!i){g=e._model.initData}else{g=e._model.cache(i,f)}g&&e.build(g)},build:function(f){var e=this,g=0,h=[];if(f.length==0){e.hide()}else{for(;g<f.length;g++){h.push(JC.f.printf(e._model.listItemTpl(),f[g].id,f[g].label,g,g===0?c.Model.CLASS_ACTIVE:""))}e._model.popup().html(h.join(""))}},currentIndex:function(f){var e=this,i=e._model.popup(),h=e._model.listItems(),g=-1;if(!h.length){return}h.each(function(k){var j=d(this);if(j.hasClass(c.Model.CLASS_ACTIVE)){g=k;return false}});if(g<0){g=f?0:h.length-1}else{g=f?g+1:g-1;if(g<0){g=h.length-1}else{if(g>=h.length){g=0}}}return g},updateListIndex:function(f){var e=this,g=e.currentIndex(f);e.updateIndex(g)},updateIndex:function(f,h){var e=this,g=e._model.listItems();e.removeActiveClass();d(g[f]).addClass(c.Model.CLASS_ACTIVE);!h&&e.setScroll(f)},setScroll:function(g){var e=this,j=e._model.listItems().eq(g),h=j.position().top+j.height(),f=e._model.popup().innerHeight(),i=e._model.popup().scrollTop();h=h+i;if(g==-1){e._model.selector().focus();e._model.listItems().removeClass(c.Model.CLASS_ACTIVE)}else{e._model.listItems().removeClass(c.Model.CLASS_ACTIVE);j.addClass(c.Model.CLASS_ACTIVE);if(h>f){e._model.popup().scrollTop(h-f)}if(j.position().top<0){e._model.popup().scrollTop(0)}}c.Model.SCROLL_TIMEOUT&&clearTimeout(c.Model.SCROLL_TIMEOUT);c.Model.SCROLL_TIMEOUT=setTimeout(function(){c.Model.isScroll=false},500)},removeActiveClass:function(){this._model.listItems().removeClass(c.Model.CLASS_ACTIVE)}});d.event.special[c.Model.REMOVE]={remove:function(e){if(e.handler){e.handler()}}};d(window).on("resize",function(e){d("input.js_compAutoComplete").each(function(){var f=c.getInstance(d(this));f&&f.fixPosition()})});d(document).on("click",function(){d("ul.js_compAutoCompleteBox, div.js_compAutoCompleteBox").hide()});d(document).delegate("input.js_compAutoComplete","focus",function(e){!c.getInstance(this)&&new c(this)})}(jQuery));return JC.AutoComplete})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));