(function(b,a){b(["JC.BaseMVC"],function(){JC.AutoComplete=c;function c(d){d&&(d=$(d));if(c.getInstance(d)){return c.getInstance(d)}c.getInstance(d,this);this._model=new c.Model(d);this._view=new c.View(this._model);this._init();JC.log("AutoComplete inited",new Date().getTime())}c.getInstance=function(d,e){if(typeof d=="string"&&!/</.test(d)){d=$(d)}if(!(d&&d.length)||(typeof d=="string")){return}typeof e!="undefined"&&d.data(c.Model._instanceName,e);return d.data(c.Model._instanceName)};c.init=function(d){var e=[];d=$(d||document);if(d&&d.length){if(d.hasClass("js_compAutoComplete")){e.push(new c(d))}else{d.find("input.js_compAutoComplete").each(function(){e.push(new c(this))})}}return e};c.update=function(d,f){var e=c.getInstance(d);!e&&(e=new c(d));e&&e.update(f);return e};c.ajaxUpdate=function(d,f,g){var e=c.getInstance(d);!e&&(e=new c(d));e&&e.ajaxUpdate(f,g);return e};c.dataFilter;c.fixHtmlEntity=true;BaseMVC.build(c);JC.f.extendObject(c.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var d=this;d._model.selector().on("click",function(f){f.stopPropagation()});d._model.selector().on("focus",function(){d._view.updateList();d.trigger(c.Model.SHOW);d.selector().addClass(c.Model.CLASS_FAKE)});d._model.selector().on("blur",function(){d._model.preVal=d._model.selector().val().trim();d.selector().removeClass(c.Model.CLASS_FAKE);d._model.verifyKey()});d._model.selector().on("keyup",function(g){var h=g.keyCode,f=$(this),i=f.val().trim();if(h==38||h==40){c.Model.isScroll=true}JC.log("keyup",h,new Date().getTime());if(h){switch(h){case 38:case 40:g.preventDefault();case 37:case 39:return;case 27:d.trigger(c.Model.HIDDEN);return}}});d._model.selector().on("keydown",function(f){var g=f.keyCode,h=d._model.selector().val().trim();if(g==38||g==40){c.Model.isScroll=true}JC.log("keydown",new Date().getTime());if(g){switch(g){case 40:case 38:case 13:if(!d._model.popup().is(":visible")){return}break}if(!d._model.popup().is(":visible")){d.trigger(c.Model.SHOW)}switch(g){case 40:case 38:d.trigger(c.Model.UPDATE_LIST_INDEX,[g,f]);return;case 37:case 39:return;case 13:d.trigger(c.Model.ENTER,[f]);return;case 9:case 27:d.trigger(c.Model.HIDDEN);return}}d._model.keydownTimeout(setTimeout(function(){d.trigger(c.Model.UPDATE_LIST)},200))});d._model.popup().on("click",function(f){f.stopPropagation()});d._model.popup().delegate("li","click",function(f){if(!$(this).is("["+d._model.cacLabelKey()+"]")){return}d.trigger(c.Model.CHANGE,[$(this)]);d.trigger(c.Model.HIDDEN);d._model.blurTimeout(setTimeout(function(){d._model.selector().trigger("blur")},50))});d.on(c.Model.HIDDEN,function(){d._view.hide()});d.on(c.Model.SHOW,function(){d._view.show()});d._model.popup().delegate("> li","mouseenter",function e(f){if(c.Model.isScroll){return}d._view.updateIndex($(this).attr("data-index"),true)});d.on(c.Model.ENTER,function(g,f){d._model.cacPreventEnter()&&f.preventDefault();var h=d._model.selectedItem();h&&h.length&&d.trigger(c.Model.CHANGE,[h]);d.trigger(c.Model.HIDDEN)});d.on(c.Model.UPDATE_LIST_INDEX,function(g,h,f){f.preventDefault();JC.log(c.Model.UPDATE_LIST_INDEX,h,new Date().getTime());d._view.updateListIndex(h==40?true:false);var i=d._model.selectedItem();i&&i.length&&d.trigger(c.Model.CHANGE,[i])});d.on(c.Model.UPDATE_LIST,function(f){this._view.updateList(this._model.selector())});d.on(c.Model.CHANGE,function(f,g){d._model.setSelectorData(g)});d.on(c.Model.UPDATE,function(g,f,h){d._model.initPopupData(f);d._view.build(f);h&&h.call(d,f)});d.on(c.Model.CLEAR,function(f){d._model.selector().val("");d._model.setIdSelectorData()});d._model.selector().on(c.Model.REMOVE,function(){try{d._model.popup().remove()}catch(f){}})},_inited:function(){var d=this;d._model.initData=d._model.dataItems();d.ajaxUpdate();if(!d._model.selector().is("[validCheckTimeout]")){d._model.selector().attr("validCheckTimeout",d._model.cacValidCheckTimeout())}},idSelector:function(){return this._model.cacIdSelector()},idVal:function(){return this._model.cacIdVal()},ajaxUpdate:function(d,e){this._model.ajaxData(d,e);return this},show:function(){var d=this;setTimeout(function(){d.trigger(c.Model.SHOW)},1);return d},hide:function(){this.trigger(c.Model.HIDDEN);return this},popup:function(){return this._model.popup()},update:function(e){var d=this;!d._model.firstUpdate&&d.clear();d._model.firstUpdate=false;e=d._model.cacDataFilter(e);d.trigger(c.Model.UPDATE,[e]);d.trigger(c.Model.UPDATE_LIST);return d},clear:function(){this.trigger(c.Model.CLEAR);return this},fixPosition:function(){var d=this._model.popup();d&&d.length&&d.is(":visible")&&this._view.show();return this}});c.Model._instanceName="AutoComplete";c.Model.UPDATE="AC_UPDATE";c.Model.CLEAR="AC_CLEAR";c.Model.ENTER="AC_ENTER";c.Model.CHANGE="AC_CHANGE";c.Model.HIDDEN="AC_HIDDEN";c.Model.SHOW="AC_SHOW";c.Model.UPDATE_LIST="AC_UPDATE_LIST";c.Model.UPDATE_LIST_INDEX="AC_UPDATE_LIST_INDEX";c.Model.REMOVE="AC_AUTOCOMPLETE_REMOVE";c.Model.CLASS_ACTIVE="AC_active";c.Model.CLASS_FAKE="AC_fakebox";c.Model.AJAX_CACHE={};JC.f.extendObject(c.Model.prototype,{init:function(){this.initData;this._cache={};this.firstUpdate=true},listItemTpl:function(){var d=JC.f.printf("<li "+this.cacIdKey()+'="{0}" '+this.cacLabelKey()+'="{1}" data-index="{2}" class="AC_listItem {3}">{1}</li>');return d},popup:function(){var d=this,e=d.selector().data("AC_panel");!e&&(e=this.selectorProp("cacPopup"));if(!(e&&e.length)){e=$(JC.f.printf('<ul class="AC_box js_compAutoCompleteBox"{0}>{1}</ul>',' style="display:none;position:absolute;"','<li style="text-align:center;">'+d.cacNoDataText()+"</li>"));d.selector().data("AC_panel",e);e.appendTo(document.body)}if(!this._inited){this._inited=true;e.css({width:d.cacBoxWidth()+"px"})}return e},initPopupData:function(d){this.initData=d},verifyKey:function(){if(!this.cacStrictData()){return}var e=this,k=this.selector().val().trim(),i=[],d=e.selector().is("[cacIdKey]"),j;if(!k){e.selector().val("");e.setIdSelectorData();return}if(k){var h=e.cacIdVal(),g,f;$.each(e.initData,function(n,m){if(d){var l=m.label.trim();if(l===k){j=true;!f&&e.setIdSelectorData(m.id);f=true}if(l===k&&!h){e.setIdSelectorData(h=m.id)}if(l===k&&m.id===h){i.push(m);!g&&(e.setIdSelectorData(m.id));g=true;j=true;return false}}else{if(m.label.trim()==k){i.push(m);j=true}}})}if(!j){e.selector().val("");e.setIdSelectorData()}},cache:function(d){JC.log("................cache",d);if(!(d in this._cache)){this._cache[d]=this.keyData(d)||this.initData}return this._cache[d]},dataItems:function(){var d=this,f=d.listItems(),e=[];f.each(function(i,h){var g=$(this);e.push({id:g.attr(d.cacIdKey())||"",label:g.attr(d.cacLabelKey())})});return e},ajaxData:function(e,f){var d=this,e=e||d.attrProp("cacAjaxDataUrl");if(!e){return}if(e in c.Model.AJAX_CACHE){$(d).trigger("TriggerEvent",[c.Model.UPDATE,c.Model.AJAX_CACHE[e],f]);return}$.get(e).done(function(g){g=$.parseJSON(g);g=d.cacDataFilter(g);c.Model.AJAX_CACHE[e]=g;$(d).trigger("TriggerEvent",[c.Model.UPDATE,c.Model.AJAX_CACHE[e],f])})},keyData:function(d){var f=this,e=f.initData,j=0,i=f.cacCasesensitive(),l=d.toLowerCase(),h=[[],[],[],[]],g=[];for(j=0;j<e.length;j++){var k=e[j].label.toLowerCase();if(e[j].label.indexOf(d)==0){h[e[j].tag=0].push(e[j])}else{if(!i&&k.indexOf(l)==0){h[e[j].tag=1].push(e[j])}else{if(e[j].label.indexOf(d)>0){h[e[j].tag=2].push(e[j])}else{if(!i&&k.indexOf(l)>0){h[e[j].tag=3].push(e[j])}}}}}$.each(h,function(n,m){g=g.concat(m)});return g},setSelectorData:function(e){e&&(e=$(e));if(!(e&&e.length)){return}var d=this,g=e.attr(d.cacLabelKey()).trim(),f=e.attr(d.cacIdKey()).trim();d.selector().val(g);d.selector().attr("cacIdVal",f);d.setIdSelectorData(f)},setIdSelectorData:function(e){var d=this;if(!(d.cacIdSelector()&&d.cacIdSelector().length)){return}if(typeof e!="undefined"){d.cacIdSelector().val(e);d.selector().attr("cacIdVal",e)}else{d.cacIdSelector().val("");d.selector().attr("cacIdVal","")}},listItems:function(){var d;this.popup()&&this.popup().length&&(d=this.popup().find(this.cacSubItemsSelector()));return d},selectedItem:function(){var d;this.listItems().each(function(){var e=$(this);if(e.hasClass(c.Model.CLASS_ACTIVE)){d=e;return false}});return d},keyupTimeout:function(d){this._keyupTimeout&&clearTimeout(this._keyupTimeout);this._keyupTimeout=d},keydownTimeout:function(d){this._keydownTimeout&&clearTimeout(this._keydownTimeout);this._keydownTimeout=d},blurTimeout:function(d){this._blurTimeout&&clearTimeout(this._blurTimeout);this._blurTimeout=d},cacDataFilter:function(e){var d=this,f=d.callbackProp("cacDataFilter")||c.dataFilter;f&&(e=f(e));if(d.cacFixHtmlEntity()){$.each(e,function(h,g){g.label&&(g.label=$("<p>"+g.label+"</p>").text())})}return e},cacNoDataText:function(){var d=this.attrProp("cacNoDataText")||"数据加载中, 请稍候...";return d},cacValidCheckTimeout:function(){var d=this.intProp("cacValidCheckTimeout")||c.validCheckTimeout||1;return d},cacStrictData:function(){var d=this.boolProp("cacStrictData");return d},cacFixHtmlEntity:function(){var d=c.fixHtmlEntity;this.selector().is("[cacFixHtmlEntity]")&&(d=this.boolProp("cacFixHtmlEntity"));return d},cacLabelKey:function(){var d=this.attrProp("cacLabelKey")||"data-label";return d},cacIdKey:function(d){typeof d!="undefined"&&(this.selector().attr("cacIdKey",d));var e=this.attrProp("cacIdKey")||this.cacLabelKey();return e},cacIdVal:function(){var d=this,e=d.attrProp("cacIdVal");d.cacIdSelector()&&d.cacIdSelector().length&&(e=d.cacIdSelector().val());e=(e||"").trim();return e},cacIdSelector:function(){var d=this.selectorProp("cacIdSelector");return d},cacPreventEnter:function(){var d;d=this.selector().is("[cacPreventEnter]")&&JC.f.parseBool(this.selector().attr("cacPreventEnter"));return d},cacBoxWidth:function(){var d=0||this.intProp("cacBoxWidth");!d&&(d=this.selector().width());return d},cacCasesensitive:function(){return this.boolProp("cacCasesensitive")},cacSubItemsSelector:function(){var d=this.attrProp("cacSubItemsSelector")||"> li";d+="["+this.cacLabelKey()+"]";return d}});JC.f.extendObject(c.View.prototype,{init:function(){var d=this;d._model.listItems().each(function(e){$(this).attr("data-index",e)}).removeClass(c.Model.CLASS_ACTIVE).first().addClass(c.Model.CLASS_ACTIVE)},hide:function(){var d=this;d._model.popup().hide()},show:function(){var d=this,e=d._model.selector().offset(),j=d._model.selector().prop("offsetHeight"),g=d._model.selector().prop("offsetWidth");d._model.popup().css({top:e.top+j+"px",left:e.left+"px"});var i,k=d._model.selector().val().trim(),f=d._model.cacIdVal(),h=d._model.cacLabelKey()!=d._model.cacIdKey();d._model.listItems().each(function(){var l=$(this),n=l.attr(d._model.cacLabelKey()),m=l.attr(d._model.cacIdKey());l.removeClass(c.Model.CLASS_ACTIVE);if(k==n){if(h&&f){f==m&&l.addClass(c.Model.CLASS_ACTIVE);i=l}else{l.addClass(c.Model.CLASS_ACTIVE);i=l}}});if(!i){d._model.listItems().first().addClass(c.Model.CLASS_ACTIVE)}d._model.popup().show()},updateList:function(){var d=this,g,i=[],h=d._model.selector().val().trim(),e=d._model.cacIdVal(),f;if(!h){f=d._model.initData}else{f=d._model.cache(h,e)}f&&d.build(f)},build:function(e){var d=this,f=0,g=[];if(e.length==0){d.hide()}else{for(;f<e.length;f++){g.push(JC.f.printf(d._model.listItemTpl(),e[f].id,e[f].label,f,f===0?c.Model.CLASS_ACTIVE:""))}d._model.popup().html(g.join(""))}},currentIndex:function(e){var d=this,h=d._model.popup(),g=d._model.listItems(),f=-1;if(!g.length){return}g.each(function(j){var i=$(this);if(i.hasClass(c.Model.CLASS_ACTIVE)){f=j;return false}});if(f<0){f=e?0:g.length-1}else{f=e?f+1:f-1;if(f<0){f=g.length-1}else{if(f>=g.length){f=0}}}return f},updateListIndex:function(e){var d=this,f=d.currentIndex(e);d.updateIndex(f)},updateIndex:function(e,g){var d=this,f=d._model.listItems();d.removeActiveClass();$(f[e]).addClass(c.Model.CLASS_ACTIVE);!g&&d.setScroll(e)},setScroll:function(f){var d=this,i=d._model.listItems().eq(f),g=i.position().top+i.height(),e=d._model.popup().innerHeight(),h=d._model.popup().scrollTop();g=g+h;if(f==-1){d._model.selector().focus();d._model.listItems().removeClass(c.Model.CLASS_ACTIVE)}else{d._model.listItems().removeClass(c.Model.CLASS_ACTIVE);i.addClass(c.Model.CLASS_ACTIVE);if(g>e){d._model.popup().scrollTop(g-e)}if(i.position().top<0){d._model.popup().scrollTop(0)}}c.Model.SCROLL_TIMEOUT&&clearTimeout(c.Model.SCROLL_TIMEOUT);c.Model.SCROLL_TIMEOUT=setTimeout(function(){c.Model.isScroll=false},500)},removeActiveClass:function(){this._model.listItems().removeClass(c.Model.CLASS_ACTIVE)}});$.event.special[c.Model.REMOVE]={remove:function(d){if(d.handler){d.handler()}}};$(window).on("resize",function(d){$("input.js_compAutoComplete").each(function(){var e=c.getInstance($(this));e&&e.fixPosition()})});$(document).on("click",function(){$("ul.js_compAutoCompleteBox, div.js_compAutoCompleteBox").hide()});$(document).delegate("input.js_compAutoComplete","focus",function(d){!c.getInstance(this)&&new c(this)});return JC.AutoComplete})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));