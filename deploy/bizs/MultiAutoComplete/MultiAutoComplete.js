(function(b,a){b(["JC.AutoComplete","JC.Placeholder","JC.Panel"],function(){var d=$(document),c=$(window);JC.use&&(!JC.AutoComplete&&JC.use("JC.AutoComplete"),!JC.Placeholder&&JC.use("JC.Placeholder"),!JC.Panel&&JC.use("JC.Panel"));Bizs.MultiAutoComplete=e;function e(f){f&&(f=$(f));if(JC.BaseMVC.getInstance(f,e)){return JC.BaseMVC.getInstance(f,e)}JC.BaseMVC.getInstance(f,e,this);this._model=new e.Model(f);this._view=new e.View(this._model);this._init();JC.log(e.Model._instanceName,"all inited",new Date().getTime())}e.init=function(f){var g=[];f=$(f||document);if(f.length){if(f.is("[defaultMultiAutomComplete]")){g.push(new e(f))}else{f.find("input[defaultMultiAutomComplete]").each(function(){g.push(new e(this))})}}return g};e.ajaxRandom=true;JC.BaseMVC.build(e);JC.f.extendObject(e.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var f=this;f.on("inited",function(){f.trigger("init_relationship");f.trigger("fix_id_callback");f.trigger("init_autoComplete");f.trigger("update_selector",[f.selector()]);f.trigger("init_user_input");f._model.ready(true);f.trigger("inited_done")});f.on("init_relationship",function(g){f._model.init_relationship()});f.on("fix_id_callback",function(g){f._model.fixIdCallback()});f.on("init_autoComplete",function(g){f._model.each(function(h){h.hasClass("js_compAutoComplete")&&!JC.BaseMVC.getInstance(h,JC.AutoComplete)&&new JC.AutoComplete(h)})});f.on("update_selector",function(i,g,h){if(!(g&&g.length)){return}!h&&f.trigger("clear_selector",[g]);f.trigger("ajax_data",[g])});f.on("clear_selector",function(h,g){if(!f._model.ready()){return}f._model.clearData(g)});f.on("ajax_data",function(h,g,i){if(!g){return}f._model.ajax_data(g,i)});f.on("ajax_done",function(h,j,g,k,i){if(j&&j.errorno==0){f.trigger("update",[j,g,k,i])}else{f.trigger("ajax_error",[j,g,k])}});f.on("update",function(i,l,g,m,k){var j=JC.BaseMVC.getInstance(g,JC.AutoComplete),n,h;if(!j){return}h=f._model.macDefaultValue(g)||undefined;j.update(l.data,h);n=f._model.nextSelector(g);if(n&&n.length){f.trigger("update_selector",[n,true])}else{!k&&f.trigger("all_updated")}});f.on("all_updated",function(){f._model.checkLast()});f.on("init_user_input",function(g){f._model.each(function(h){h.on("focus",function(i){h.data("old_value",h.val())});h.on("blur",function(i){JC.f.safeTimeout(function(){var j=h.data("old_value"),l=h.val(),k;if(j!=l){k=f._model.nextSelector(h);k&&k.length&&f.trigger("update_selector",[k])}},h,"forMultiAutoCompleteSelectorBlur",200)})})});f.on("inited_done",function(){f._model.each(function(g){f.trigger("init_addtionBox",[g])})});f.on("init_addtionBox",function(i,h){var k=f._model.macAddtionBox(h),n,j;if(!(k&&k.length)){return}n=k.find(".js_macAddtionBoxList");if(!(n&&n.length)){return}j=JC.BaseMVC.getInstance(h,JC.AutoComplete);j&&(j.on("build_data",function(){JC.f.safeTimeout(function(){m()},f,"build_data",10)}),j.on("before_click",function(p,o,r,q){if(o.hasClass("macDisable")){q._model.clickDisable(true)}else{q._model.clickDisable(false)}}));k.delegate(".js_macClearAddtionList","click",function(o){JC.confirm("是否清空内容",this,2,function(p){n.html("");k.hide()})});k.delegate(".js_macAddtionBoxItem","click",function(p){var o=$(this),q=o.attr("data-id"),r=o.attr("data-label");f._model.macAddtionItemRemoveCallback(h)&&f._model.macAddtionItemRemoveCallback(h).call(f,o,q,r,n,k);o.remove();g()});h.on("cacItemClickHanlder",function(o,u,q){if(!h.is("[macAddtionBox]")){return}var s=u.attr("data-id"),w=u.attr("data-label"),v=n.find(f._model.macAddtionBoxItemSelector(h)),t=f._model.macAddtionBoxItemTpl(h),r,p;v.each(function(x,y){y=$(y);if(y.attr("data-id")==s){p=true;return false}});if(p){return}l(u);r=$(JC.f.printf(t,s,w));r.appendTo(n);r.attr("data-id",s);r.attr("data-label",w);k.show();f._model.macAddtionItemAddCallback(h)&&f._model.macAddtionItemAddCallback(h).call(f,r,s,w,n,k)});g();function m(){var p=n.find(f._model.macAddtionBoxItemSelector(h)),o=j._model.listItems();if(!(p.length&&o.length)){return}$.each(p,function(r,q){q=$(q);$.each(o,function(s,t){t=$(t);if(t.attr("data-id")==q.attr("data-id")){l(t)}})})}function l(o){o.addClass("macDisable")}function g(){var o=n.find(f._model.macAddtionBoxItemSelector(h));o.length?k.show():k.hide()}})},_inited:function(){this.trigger("inited")}});e.Model._instanceName="JCMultiAutoComplete";JC.f.extendObject(e.Model.prototype,{init:function(){},macAddtionItemAddCallback:function(f){return this.callbackProp(f,"macAddtionItemAddCallback")},macAddtionItemRemoveCallback:function(f){return this.callbackProp(f,"macAddtionItemRemoveCallback")},macAddtionBoxItemSelector:function(f){return this.attrProp(f,"macAddtionBoxItemSelector")},macAddtionBoxItemTpl:function(f){return JC.f.scriptContent(this.selectorProp(f,"macAddtionBoxItemTpl"))},macAddtionBox:function(f){return this.selectorProp(f,"macAddtionBox")},ready:function(f){typeof f!="undefined"&&(this._ready=f);return this._ready},clearData:function(g){var f=this,i=f.nextSelector(g),h=JC.BaseMVC.getInstance(g,JC.AutoComplete);h&&h.clearAll();i&&f.clearData(i)},init_relationship:function(g,i){var f=this,g=g||f.selector(),h;i&&(g.data("prevSelector",i));if(g.is("[macTarget]")){h=JC.f.parentSelector(g,g.attr("macTarget"));if((h&&h.length)){g.data("nextSelector",h);f.init_relationship(h,g)}}else{f.lastSelecotr(g)}},fixIdCallback:function(){var f=this;f.each(function(g){!g.is("[macIdCallback]")&&g.attr("macIdCallback","MultiAutoCompleteIdCallback");!g.is("[cacDataFilter]")&&g.attr("cacDataFilter","MultiAutoCompleteDataFilter")})},firstSelector:function(){return this.selector()},lastSelecotr:function(f){f&&(this._lastSelecotr=f);return this._lastSelecotr},nextSelector:function(f){if(f){return $(f).data("nextSelector")}},prevSelector:function(f){if(f){return $(f).data("prevSelector")}},macAddtionUrl:function(f){return f.attr("macAddtionUrl")},checkLast:function(){var f=this,g=f.lastSelecotr(),i=f.prevSelector(g),h;while(i&&i.length){i.val()&&(h=true);if(h){break}i=f.prevSelector(i)}!h&&f.macAddtionUrl(g)&&f.ajax_data(g,true,f.macAddtionUrl(g))},ajax_data:function(h,j,l){var g=this,i=l||h.attr("macUrl"),k,f;if(!i){return}g.ajax_random(h)&&(i=JC.f.addUrlParams(i,{rnd:new Date().getTime()}));k=g.prevSelector(h);if(k&&k.length){f=g.macDefaultValue(k);f&&(i=JC.f.printf(i,f))}$.get(i).done(function(n){var m=$.parseJSON(n);g.trigger("ajax_done",[m,h,n,j])})},ajax_random:function(f){var g=e.ajaxRandom;f.is("[macAjaxRandom]")&&(g=JC.f.parseBool(f.attr("macAjaxRandom")));return g},each:function(h,g){var f=this,i;g=g||f.selector();if(g&&g.length){h.call(f,g);i=f.nextSelector(g);i&&i.length&&f.each(h,i)}},macDefaultValue:function(f){var h=f.attr("macDefaultValue"),g;if(f.is("[cacIdSelector]")){g=JC.f.parentSelector(f,f.attr("cacIdSelector"));g&&g.length&&(h=g.val())}return h}});JC.f.extendObject(e.View.prototype,{init:function(){}});window.MultiAutoCompleteIdCallback=function(){};window.MultiAutoCompleteDataFilter=function(f){if(f.data&&f.data.length){f=f.data}$.each(f,function(h,g){g.length&&(f[h]={id:g[0],label:g[1]})});return f};d.ready(function(){JC.f.safeTimeout(function(){e.autoInit&&e.init()},null,"MultiAutoCompleteInit",5)});return Bizs.MultiAutoComplete})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));