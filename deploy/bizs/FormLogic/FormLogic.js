(function(b,a){b(["JC.BaseMVC","JC.Valid","JC.Form","JC.Panel"],function(){(function(d){window.Bizs=window.Bizs||{};Bizs.FormLogic=c;function c(e){e&&(e=d(e));if(c.getInstance(e)){return c.getInstance(e)}c.getInstance(e,this);this._model=new c.Model(e);this._view=new c.View(this._model);this._init()}c.getInstance=function(e,f){if(typeof e=="string"&&!/</.test(e)){e=d(e)}if(!(e&&e.length)||(typeof e=="string")){return}typeof f!="undefined"&&e.data("FormLogicIns",f);return e.data("FormLogicIns")};if(!b.amd&&JC.use){!JC.Valid&&JC.use("Valid");!JC.Form&&JC.use("Form");!JC.Panel&&JC.use("Panel")}c.init=function(e){var f=[];e&&(e=d(e));if(!(e&&e.length)){return}if(e.prop("nodeName").toLowerCase()=="form"){f.push(new c(e))}else{e.find("form.js_bizsFormLogic, form.js_autoFormLogic").each(function(){f.push(new c(this))})}return f};c.popupCloseMs=2000;c.formSubmitType="";c.submitDisable=true;c.resetAfterSubmit=true;c.processErrorCb;c.prototype={_beforeInit:function(){},_initHanlderEvent:function(){var e=this,f=e._model.formType();e._view.initQueryVal();e.selector().on("submit",function(g){e._model.isSubmited(true);var h,i=e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);i&&(i=d(i));if(i&&i.length){h=JC.f.parseBool(i.attr("formSubmitIgnoreCheck"));JC.Valid.ignore(e.selector(),!h)}else{JC.Valid.ignore(e.selector(),true)}if(e._model.formBeforeProcess()){if(e._model.formBeforeProcess().call(e.selector(),g,e)===false){return e._model.prevent(g)}}if(!JC.Valid.check(e.selector())){if(e._model.formProcessError()){e._model.formProcessError().call(e.selector(),g,e)}return e._model.prevent(g)}if(e._model.formAfterProcess()){if(e._model.formAfterProcess().call(e.selector(),g,e)===false){return e._model.prevent(g)}}if(e.selector().data(c.Model.SUBMIT_CONFIRM_BUTTON)){e.trigger(c.Model.EVT_CONFIRM);return e._model.prevent(g)}e.trigger("ProcessDone")});e.on("BindFrame",function(h){var j,i=e._model.formType(),g;if(i!=c.Model.AJAX){return}j=e._model.frame();j.on("load",function(m){var n=j.prop("contentWindow"),l=n.document.body,k=d("<div>"+(d.trim(l.innerHTML)||"")+"</div>").text();if(!e._model.isSubmited()){return}JC.log("common ajax done");e.trigger("AjaxDone",[k])})});e.on("AjaxDone",function(h,l){var i=e._model.selector().find("button[type=reset], input[type=reset]");e._model.formSubmitDisable()&&e.trigger("EnableSubmit");var g,k,n=e._model.formAjaxResultType();if(n=="json"){try{g=d.parseJSON(l)}catch(j){k=true;g=l}}if(k){var m=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',l);JC.Dialog.alert(m,1);return}g&&n=="json"&&"errorno" in g&&!parseInt(g.errorno,10)&&e._model.formResetAfterSubmit()&&i.length&&e.selector().trigger("reset");g=g||l||{};e._model.formAjaxDone()&&e._model.formAjaxDone().call(e._model.selector(),g,e._model.selector().data(c.Model.GENERIC_SUBMIT_BUTTON),e);e._model.formResetAfterSubmit()&&!e._model.userFormAjaxDone()&&i.length&&e.selector().trigger("reset")});e.on("ProcessDone",function(){e._model.formSubmitDisable()&&e.selector().find("input[type=submit], button[type=submit]").each(function(){d(this).prop("disabled",true)})});e.on(c.Model.EVT_CONFIRM,function(g){var h=e.selector().data(c.Model.SUBMIT_CONFIRM_BUTTON);h&&(h=d(h));if(!(h&&h.length)){return}var i;if(e._model.formConfirmPopupType(h)=="dialog"){i=JC.Dialog.confirm(e._model.formSubmitConfirm(h),2)}else{i=JC.confirm(e._model.formSubmitConfirm(h),h,2)}i.on("confirm",function(){e.selector().data(c.Model.SUBMIT_CONFIRM_BUTTON,null);e.selector().trigger("submit")});i.on("close",function(){e.selector().data(c.Model.SUBMIT_CONFIRM_BUTTON,null)})});e.selector().on("reset",function(g){if(e.selector().data(c.Model.RESET_CONFIRM_BUTTON)){e.trigger(c.Model.EVT_RESET);return e._model.prevent(g)}else{e._view.reset();e.trigger("EnableSubmit")}});e.on("EnableSubmit",function(){e.selector().find("input[type=submit], button[type=submit]").each(function(){d(this).prop("disabled",false)})});e.on(c.Model.EVT_RESET,function(g){var h=e.selector().data(c.Model.RESET_CONFIRM_BUTTON);h&&(h=d(h));if(!(h&&h.length)){return}var i;if(e._model.formConfirmPopupType(h)=="dialog"){i=JC.Dialog.confirm(e._model.formResetConfirm(h),2)}else{i=JC.confirm(e._model.formResetConfirm(h),h,2)}i.on("confirm",function(){e.selector().data(c.Model.RESET_CONFIRM_BUTTON,null);e.selector().trigger("reset");e._view.reset();e.trigger("EnableSubmit")});i.on("close",function(){e.selector().data(c.Model.RESET_CONFIRM_BUTTON,null)})})},_inited:function(){JC.log("FormLogic#_inited",new Date().getTime());var e=this,f=e.selector().find("input[type=file][name]");f.length&&e.selector().attr("enctype","multipart/form-data")&&e.selector().attr("encoding","multipart/form-data");e.trigger("BindFrame")}};JC.BaseMVC.buildModel(c);c.Model._instanceName="FormLogicIns";c.Model.GET="get";c.Model.POST="post";c.Model.AJAX="ajax";c.Model.IFRAME="iframe";c.Model.SUBMIT_CONFIRM_BUTTON="SubmitButton";c.Model.RESET_CONFIRM_BUTTON="ResetButton";c.Model.GENERIC_SUBMIT_BUTTON="GenericSubmitButton";c.Model.GENERIC_RESET_BUTTON="GenericResetButton";c.Model.EVT_CONFIRM="ConfirmEvent";c.Model.EVT_RESET="ResetEvent";c.Model.EVT_AJAX_SUBMIT="AjaxSubmit";c.Model.INS_COUNT=1;c.Model.prototype={init:function(){this.id()},id:function(){if(!this._id){this._id="FormLogicIns_"+(c.Model.INS_COUNT++)}return this._id},isSubmited:function(e){typeof e!="undefined"&&(this._submited=e);return this._submited},formType:function(){var e=this.stringProp("method");!e&&(e=c.Model.GET);e=this.stringProp("formType")||e;return e},frame:function(){var e=this;if(!(e._frame&&e._frame.length&&e._frame.parent())){if(e.selector().is("[target]")){e._frame=d(JC.f.printf("iframe[name={0}]",e.selector().attr("target")))}if(!(e._frame&&e._frame.length)){e.selector().prop("target",e.frameId());e._frame=d(JC.f.printf(c.frameTpl,e.frameId()));e.selector().after(e._frame)}}return e._frame},frameId:function(){return this.id()+"_iframe"},formSubmitType:function(){var e=this.stringProp("ajaxSubmitType")||this.stringProp("formSubmitType")||c.formSubmitType||"plugins";return e.toLowerCase()},formAjaxResultType:function(){var e=this.stringProp("formAjaxResultType")||"json";return e},formAjaxMethod:function(){var e=this.stringProp("formAjaxMethod")||this.stringProp("method");!e&&(e=c.Model.GET);return e.toLowerCase()},formAjaxAction:function(){var e=this.attrProp("formAjaxAction")||this.attrProp("action")||"?";return JC.f.urlDetect(e)},formSubmitDisable:function(){var e=this,g=c.submitDisable,f=e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);e.selector().is("[formSubmitDisable]")&&(g=JC.f.parseBool(e.selector().attr("formSubmitDisable")));f&&f.is("[formSubmitDisable]")&&(g=JC.f.parseBool(f.attr("formSubmitDisable")));return g},formResetAfterSubmit:function(){var e=this,f=c.resetAfterSubmit;e.selector().is("[formResetAfterSubmit]")&&(f=JC.f.parseBool(e.selector().attr("formResetAfterSubmit")));return f},formAjaxDone:function(){var e=this,g=e._innerAjaxDone,f=e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);g=e.userFormAjaxDone()||g;return g},userFormAjaxDone:function(){var e=this,g,f=e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);e.selector().is("[formAjaxDone]")&&(g=this.callbackProp("formAjaxDone")||g);f&&(f=d(f)).length&&(g=e.callbackProp(f,"formAjaxDone")||g);return g},_innerAjaxDone:function(f,i,e){var h=d(this),j,g="";f.data&&f.data.returnurl&&(g=f.data.returnurl);f.url&&(g=f.url);if(f.errorno){j=JC.Dialog.alert(f.errmsg||"操作失败, 请重新尝试!",1)}else{j=JC.Dialog.msgbox(f.errmsg||"操作成功",0,function(){g=g||e._model.formAjaxDoneAction();if(g){try{g=decodeURIComponent(g)}catch(k){}/^URL/.test(g)&&(g=JC.f.urlDetect(g));JC.f.reloadPage(g)}},e._model.formPopupCloseMs())}},formPopupCloseMs:function(f){var e=this,g=c.popupCloseMs,f=f||e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);e.selector().is("[formPopupCloseMs]")&&(g=this.intProp("formPopupCloseMs")||g);f&&(f=d(f)).length&&(g=e.intProp(f,"formPopupCloseMs")||g);return g},formAjaxDoneAction:function(){var e=this,g="",f=e.selector().data(c.Model.GENERIC_SUBMIT_BUTTON);e.selector().is("[formAjaxDoneAction]")&&(g=this.attrProp("formAjaxDoneAction")||g);f&&(f=d(f)).length&&(g=e.attrProp(f,"formAjaxDoneAction")||g);return JC.f.urlDetect(g)},formBeforeProcess:function(){return this.callbackProp("formBeforeProcess")},formAfterProcess:function(){return this.callbackProp("formAfterProcess")},formProcessError:function(){var e=this.callbackProp("formProcessError")||c.processErrorCb;return e},prevent:function(e){e&&e.preventDefault();return false},formConfirmPopupType:function(e){var f=this.stringProp("formConfirmPopupType")||"dialog";e&&(e=d(e)).length&&e.is("[formConfirmPopupType]")&&(f=e.attr("formConfirmPopupType"));return f.toLowerCase()},formResetUrl:function(){var e=this,g=e.stringProp("formResetUrl"),f=e.selector().data(c.Model.GENERIC_RESET_BUTTON);f&&(f=d(f)).length&&(g=e.attrProp(f,"formResetUrl")||g);return JC.f.urlDetect(g)},formSubmitConfirm:function(e){var f=this.stringProp("formSubmitConfirm");e&&(e=d(e)).length&&e.is("[formSubmitConfirm]")&&(f=this.stringProp(e,"formSubmitConfirm"));!f&&(f="确定要提交吗?");return f.trim()},formResetConfirm:function(e){var f=this.stringProp("formResetConfirm");e&&(e=d(e)).length&&e.is("[formResetConfirm]")&&(f=this.stringProp(e,"formResetConfirm"));!f&&(f="确定要重置吗?");return f.trim()}};JC.BaseMVC.buildView(c);c.View.prototype={initQueryVal:function(){var e=this;if(e._model.formType()!=c.Model.GET){return}JC.Form&&JC.Form.initAutoFill(e._model.selector())},reset:function(g){var e=this,f=e._model.formResetUrl();f&&JC.f.reloadPage(f);e._model.resetTimeout&&clearTimeout(e._model.resetTimeout);e._model.resetTimeout=setTimeout(function(){var h=e._model.selector();h.find("input[type=text], input[type=password], input[type=file], textarea").val("");h.find("select").each(function(){var k=d(this);var i=k.find("option");if(i.length>1){k.val(d(i[0]).val())}var j=k.is("[ignoreprocess]");k.attr("ignoreprocess",true);k.trigger("change");setTimeout(function(){!j&&k.removeAttr("ignoreprocess")},500)});JC.Valid&&JC.Valid.clearError(h)},50);JC.hideAllPopup(1)}};JC.BaseMVC.build(c,"Bizs");d(document).delegate("input[formSubmitConfirm], button[formSubmitConfirm]","click",function(g){var f=d(this),e=JC.f.getJqParent(f,"form"),h=c.getInstance(e),i;if(e&&e.length){if(h){e.data(c.Model.SUBMIT_CONFIRM_BUTTON,null);if(f.is("[formConfirmCheckSelector]")){i=JC.f.parentSelector(f,f.attr("formConfirmCheckSelector"));if(!(i&&i.length)){return}}else{if(f.is("[formConfirmCheckCallback]")){i=window[f.attr("formConfirmCheckCallback")];if(i){if(!i.call(e,f,g,h)){return}}}}}e.data(c.Model.SUBMIT_CONFIRM_BUTTON,f)}});d(document).delegate("input[formResetConfirm], button[formResetConfirm]","click",function(g){var f=d(this),e=JC.f.getJqParent(f,"form");e&&e.length&&e.data(c.Model.RESET_CONFIRM_BUTTON,f)});d(document).delegate("input[type=reset], button[type=reset]","click",function(g){var f=d(this),e=JC.f.getJqParent(f,"form");e&&e.length&&e.data(c.Model.GENERIC_RESET_BUTTON,f)});d(document).delegate("input[type=submit], button[type=submit]","click",function(g){var f=d(this),e=JC.f.getJqParent(f,"form");e&&e.length&&e.data(c.Model.GENERIC_SUBMIT_BUTTON,f)});d(document).delegate("input[buttonClickBindSelector], button[buttonClickBindSelector]","click",function(g){var e=d(this),f=JC.f.parentSelector(e,e.attr("buttonClickBindSelector"));if(!(f&&f.length)){return}f.val(e.val()||"")});d(document).delegate("a[buttonReturnUrl], input[buttonReturnUrl], button[buttonReturnUrl]","click",function(g){var f=d(this),h=f.attr("buttonReturnUrl").trim(),k=f.is("[returnConfirm]")?f.attr("returnConfirm"):"",e=f.is("[popuptype]")?f.attr("popuptype"):"confirm",j=parseInt(f.is("[popupstatus]")?f.attr("popupstatus"):"2",10),i;if(!h){return}h=JC.f.urlDetect(h);f.prop("nodeName").toLowerCase()=="a"&&g.preventDefault();if(k){switch(e){case"dialog.confirm":i=JC.Dialog.confirm(k,j);break;default:i=JC.confirm(k,f,j);break}i.on("confirm",function(){JC.f.reloadPage(h)})}else{JC.f.reloadPage(h)}});c.frameTpl='<iframe src="about:blank" id="{0}" name="{0}" frameborder="0" class="BFLIframe" style="display:none;"></iframe>';d(document).ready(function(){setTimeout(function(){c.autoInit&&c.init(d(document))},1)})}(jQuery));return Bizs.FormLogic})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));