(function(b,a){b(["JC.BaseMVC","JC.Panel"],function(){var d=$(document),c=$(window);Bizs.MultiselectPanel=e;function e(f){f&&(f=$(f));if(JC.BaseMVC.getInstance(f,e)){return JC.BaseMVC.getInstance(f,e)}JC.BaseMVC.getInstance(f,e,this);this._model=new e.Model(f);this._view=new e.View(this._model);this._init();JC.log(e.Model._instanceName,"all inited",new Date().getTime())}e.init=function(f){var g=[];f=$(f||document);if(f.length){if(f.hasClass("js_bizMultiselectPanel")){g.push(new e(f))}else{f.find("input.js_bizMultiselectPanel, button.js_bizMultiselectPanel").each(function(){g.push(new e(this))})}}return g};JC.BaseMVC.build(e);JC.f.extendObject(e.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var f=this;f.on("inited",function(){f.trigger("init_top")});var g=new JC.Panel(f._model.panel());f._model.panelIns(g);g.on("close",function(h,i){i.hide();return false});g.on("hide",function(){JC.f.safeTimeout(function(){f.trigger("updateStatus")},f.selector(),"HIDE_PANEL",50)});g.on("beforeshow",function(){JC.hideAllPanel()});g.layout().on("click",function(h){JC.f.safeTimeout(function(){f.trigger("saveParentId")},f.selector(),"HIDE_PANEL",50)});if(f._model.popupHideButton()){g.offsetTop(-f.selector().prop("offsetHeight")-1)}f.selector().on("click",function(h){g.show(f.selector())});f.on("init_top",function(h){f._model.initTop();f.trigger("saveParentId")});f.on("updateTop",function(i,j,h){f._view.buildTop(j);f.trigger("saveParentId")});f.on("updateChild",function(i,j,k,h){f._view.buildChild(j,k);var l=f._model.getCkItem(j);f._view.topCk(j,l.prop("checked"))});g.layout().delegate("."+f._model.openClass(),"click",function(i){var h=$(this),j=h.data("id");h.addClass(f._model.closeClass()).removeClass(f._model.openClass());f._view.showChild(j);f.trigger("initChildBox",[j])});f.on("initChildBox",function(h,i){if(!f._model.getChildBox(i).data("inited")){f._model.getChildBox(i).data("inited",true);f._model.initChild(i)}});g.layout().delegate("."+f._model.closeClass(),"click",function(i){var h=$(this),j=h.data("id");h.addClass(f._model.openClass()).removeClass(f._model.closeClass());f._view.hideChild(j)});g.layout().delegate("input.js_bmspTopCk","change",function(i){var h=$(this),j=h.val();f._view.topCk(j,h.prop("checked"));h.prop("checked")&&f.trigger("initChildBox",[j])});g.layout().delegate("input.js_bmspChildCk","change",function(i){var h=$(this),j=h.val(),k=h.data("parentid");f._view.childCk(k,j)});f.on("updateStatus",function(i){var h=g.find("input.js_bmspChildCk:checked");if(h.length){f.selector().val(JC.f.printf(f._model.hasItemText(),h.length))}else{f.selector().val(f._model.noItemText())}f.trigger("saveParentId")});f.on("saveParentId",function(h){var k=f._model.saveTopIdSelector();if(k&&k.length){var l=f._model.panelIns().find("input.js_bmspTopCk:checked"),j=f._model.panelIns().find("input.js_bmspChildCk:checked"),i={},m=[];l.each(function(){var n=$(this).val();if(!(n in i)){m.push(n)}i[n]=""});j.each(function(){var n=$(this).data("parentid");if(!(n in i)){m.push(n)}i[n]=""});k.val(m.join(","))}})},_inited:function(){this.trigger("inited")}});e.Model._instanceName="JCMultiselectPanel";JC.f.extendObject(e.Model.prototype,{init:function(){},url:function(){return this.attrProp("bmspUrl")},childUrl:function(){return this.attrProp("bmspChildUrl")},popupHideButton:function(){return this.boolProp("bmspPopupHideButton")},panel:function(){return this.selectorProp("bmspPanel")},panelIns:function(f){typeof f!="undefined"&&(this._panelIns=f);return this._panelIns},panelBoxSelector:function(){return this.panelIns().find(this.attrProp("bmspPanelBoxSelector")||"js_bmspPanelBox")},topTpl:function(){return this.scriptTplProp("bmspTopTpl")},childTpl:function(){return this.scriptTplProp("bmspChildTpl")},childBox:function(f){return f.find(".js_bmspChildBox")},openClass:function(){return this.attrProp("bmspOpenClass")},closeClass:function(){return this.attrProp("bmspCloseClass")},openSelector:function(){return this.selectorProp("."+this.openClass())},closeSelector:function(){return this.selectorProp("."+this.closeClass())},saveTopIdSelector:function(){return this.selectorProp("bmspSaveTopIdSelector")},initTop:function(){var f=this,g;$.get(f.url()).done(function(h){g=$.parseJSON(h);g&&!g.errorno&&g.data&&f.trigger("updateTop",[g.data,h])})},initChild:function(g){var f=this,h;$.get(JC.f.printf(f.childUrl(),g)).done(function(i){h=$.parseJSON(i);h&&!h.errorno&&h.data&&f.trigger("updateChild",[g,h.data,i])})},getChildBox:function(f){return this.panelIns().find(JC.f.printf(".js_bmspChildBox[data-id={0}]",f))},getIcon:function(f){return this.panelIns().find(JC.f.printf(".js_bmspIcon[data-id={0}]",f))},getCkItem:function(f){return this.panelIns().find(JC.f.printf("input.js_bmspCkItem[value={0}]",f))},noItemText:function(){return this.attrProp("bmspNoItemText")},hasItemText:function(){return this.attrProp("bmspHasItemText")}});JC.f.extendObject(e.View.prototype,{init:function(){},buildTop:function(h){var f=this,i=f._model.panelBoxSelector(),g=f._model.topTpl(),j=[];$.each(h,function(l,k){j.push(JC.f.printf(g,k[0],k[1]))});i.html(j.join(""))},buildChild:function(h,i){var f=this,j=f._model.getChildBox(h),g=f._model.childTpl(),k=[];$.each(i,function(m,l){k.push(JC.f.printf(g,l[0],l[1],h))});j.html(k.join(""))},showChild:function(f){this._model.getChildBox(f).show()},hideChild:function(f){this._model.getChildBox(f).hide()},topCk:function(g,f){var h=this._model.getChildBox(g);h.find("input.js_bmspChildCk").prop("checked",f)},childCk:function(j,h){var f=this,i=this._model.getChildBox(j),g=f._model.getCkItem(j);if(i.find("input.js_bmspChildCk:not(:checked)").length){g.prop("checked",false)}else{g.prop("checked",true)}}});c.on("BMSP_AUTO_FILL_DEFAULT_DATA",function(h,g){var f,j,i;if(!(g&&g.length&&g.attr("bmspDefaultFillData")&&(i=window[g.attr("bmspDefaultFillData")]))&&i.parents){return}c.trigger("BMSP_AUTO_FILL",[g,i.parents,i.children])});c.on("BMSP_AUTO_FILL_URL_DATA",function(h,g){var f,i;if(!(g.attr("bmspAutoFillTopKey")&&(f=JC.f.getUrlParams(g.attr("bmspAutoFillTopKey")))&&f.length)){return}f=decodeURIComponent(f).split(",");i=JC.f.getUrlParams(g.attr("bmspAutoFillChildKey"));c.trigger("BMSP_AUTO_FILL",[g,f,i])});c.on("BMSP_AUTO_FILL",function(h,g,f,j){if(!(g&&g.length&&f&&f.length)){return}var k,i;i=JC.BaseMVC.getInstance(g,Bizs.MultiselectPanel)||new Bizs.MultiselectPanel(g);k=f.slice();i.on("updateTop",function(){if(f.length){var l=f.shift();i.trigger("initChildBox",[l]);i._model.getIcon(l).trigger("click");i.on("updateChild",function(){if(f.length){l=f.shift();i.trigger("initChildBox",[l]);i._model.getIcon(l).trigger("click")}else{if(k.length){if(j&&j.length){j&&j.length&&$.each(j,function(n,m){i._model.getCkItem(m).prop("checked",true)});$.each(k,function(n,m){i._view.childCk(m)});i.trigger("updateStatus")}k=[]}}})}})});d.ready(function(){d.delegate("input.js_bizMultiselectPanel","click",function(g){var f=$(this),h;if(!JC.BaseMVC.getInstance(f,Bizs.MultiselectPanel)){h=new Bizs.MultiselectPanel(f);h._model.panelIns().show(f)}});$("input.js_bizMultiselectPanel").each(function(){var f=$(this);if(f.attr("bmspDefaultFillData")&&window[f.attr("bmspDefaultFillData")]){c.trigger("BMSP_AUTO_FILL_DEFAULT_DATA",[f])}else{if(f.attr("bmspAutoFillTopKey")){c.trigger("BMSP_AUTO_FILL_URL_DATA",[f])}}})});return Bizs.MultiselectPanel})}(typeof define==="function"&&define.amd?define:function(b,a,c){typeof b=="function"&&(c=b);typeof a=="function"&&(c=a);c&&c()},window));